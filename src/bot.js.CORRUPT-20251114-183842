const showRestoreMenu = require('./helpers/showRestoreMenu');
try { require('dotenv').config({ override: true, path: '/var/data/.env' }); } catch (_) { try { require('dotenv').config({ override: true }); } catch (_) {} }
const { Client, GatewayIntentBits, Partials, EmbedBuilder, ActionRowBuilder, RoleSelectMenuBuilder, UserSelectMenuBuilder, StringSelectMenuBuilder, ChannelSelectMenuBuilder, ChannelType, ButtonBuilder, ButtonStyle, ModalBuilder, TextInputBuilder, TextInputStyle, PermissionsBitField, Events, AttachmentBuilder, Collection } = require('discord.js');

const { setGuildStaffRoleIds, getGuildStaffRoleIds, ensureStorageExists, getAutoKickConfig, updateAutoKickConfig, addPendingJoiner, removePendingJoiner, updateMemberActivity, setPlannedInactivity, removePlannedInactivity, getInactivityTracking, updateLastInactivityCheck, getLevelsConfig, updateLevelsConfig, getUserStats, setUserStats, getEconomyConfig, updateEconomyConfig, getEconomyUser, setEconomyUser, getTruthDareConfig, updateTruthDareConfig, addTdChannels, removeTdChannels, addTdPrompts, deleteTdPrompts, editTdPrompt, getConfessConfig, updateConfessConfig, addConfessChannels, removeConfessChannels, incrementConfessCounter, getGeoConfig, setUserLocation, getUserLocation, getAllLocations, getAutoThreadConfig, updateAutoThreadConfig, getCountingConfig, updateCountingConfig, setCountingState, getDisboardConfig, updateDisboardConfig, getLogsConfig, updateLogsConfig, getGuildFooterLogo, getGuildCategoryBanners } = require('./storage/jsonStore');
const { downloadDiscordGifForBot } = require('./utils/discord_gif_downloader');
const { createCanvas, loadImage, GlobalFonts } = require('@napi-rs/canvas');

const fs2 = require('fs');
const path2 = require('path');

// Simple in-memory image cache
const imageCache = new Map(); // url -> { img, width, height, ts }
async function getCachedImage(url) {
  if (!url) return null;
  const cached = imageCache.get(url);
  if (cached) return cached;
  try {
    const img = await loadImage(url);
    const entry = { img, width: img.width || 1024, height: img.height || 512, ts: Date.now() };
    imageCache.set(url, entry);
    return entry;
  } catch (_) {
    return null;
  }
}
// GIF URL helpers: normalize and resolve direct media links for better embed rendering
function isLikelyDirectImageUrl(url) {
  try {
    const u = new URL(url);
    const host = String(u.hostname || '').toLowerCase();
    const pathname = String(u.pathname || '');
    
    // Force download for Tenor and Giphy (better Discord embed compatibility)
    if (host.includes('tenor.com')) return false;
    if (host.includes('giphy.com') && !host.includes('media.giphy.com') && !host.includes('i.giphy.com')) return false;
    
    // Discord CDN and direct image URLs
    if (/\.(gif|png|jpg|jpeg|webp)(?:\?|#|$)/i.test(pathname)) return true;
    if (host.includes('media.giphy.com') || host.includes('i.giphy.com')) return true;
    if (host.includes('cdn.discordapp.com') || host.includes('media.discordapp.net')) return true;
    
    return false;
  } catch (_) { return false; }
}
function normalizeGifUrlBasic(url) {
  try {
    const u = new URL(url);
    const host = String(u.hostname || '').toLowerCase();
    const path = String(u.pathname || '');
    // Convert giphy page URLs to direct media URLs
    if (host.includes('giphy.com') && (/\/gifs?\//i.test(path))) {
      const parts = path.split('/');
      const last = parts[parts.length - 1] || '';
      const id = (last.includes('-') ? last.split('-').pop() : last).replace(/[^A-Za-z0-9]/g, '');
      if (id) return `https://media.giphy.com/media/${id}/giphy.gif`;
    }
    return url;
  } catch (_) { return url; }
}
async function resolveGifUrl(url, opts) {
  const options = opts || {};
  const timeoutMs = Number(options.timeoutMs || 2500);
  const normalized = normalizeGifUrlBasic(url);
  if (isLikelyDirectImageUrl(normalized)) return normalized;
  try {
    const u = new URL(normalized);
    const host = String(u.hostname || '').toLowerCase();
    // Try to resolve Tenor page URLs to a direct media
    if (host.includes('tenor.com') && !/^media\d*\.tenor\.com$/i.test(host)) {
      const ctrl = new AbortController();
      const t = setTimeout(() => { try { ctrl.abort(); } catch (_) {} }, timeoutMs);
      let html = '';
      try {
        const r = await fetch(normalized, { signal: ctrl.signal, headers: { 'User-Agent': 'Mozilla/5.0' } });
        if (r && r.ok) html = await r.text();
      } catch (_) {}
      clearTimeout(t);
      if (html) {
        // Prefer og:image
        const mImg = html.match(/<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["']/i);
        if (mImg && mImg[1] && isLikelyDirectImageUrl(mImg[1])) return mImg[1];
        const mVid = html.match(/<meta[^>]+property=["']og:video["'][^>]+content=["']([^"']+)["']/i);
        if (mVid && mVid[1]) {
          const cand = mVid[1];
          if (isLikelyDirectImageUrl(cand)) return cand;
        }
      }
    }
    // Generic: try to resolve any page URL by scraping OpenGraph og:image as a last resort
    if (!isLikelyDirectImageUrl(normalized)) {
      const ctrl = new AbortController();
      const t = setTimeout(() => { try { ctrl.abort(); } catch (_) {} }, Math.max(1000, Math.min(timeoutMs, 3000)));
      let html = '';
      try {
        const r = await fetch(normalized, { signal: ctrl.signal, headers: { 'User-Agent': 'Mozilla/5.0' } });
        if (r && r.ok) html = await r.text();
      } catch (_) {}
      clearTimeout(t);
      if (html) {
        const mImg = html.match(/<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["']/i);
        if (mImg && mImg[1]) {
          const cand = mImg[1];
          if (isLikelyDirectImageUrl(cand)) return cand;
        }
      }
    }
  } catch (_) {}
  return normalized;
}
// Try to detect if a URL points to an image by checking Content-Type via HEAD
async function urlContentTypeIsImage(url, timeoutMs = Math.min(2000, 1500)) {
  try {
    const ctrl = new AbortController();
    const t = setTimeout(() => { try { ctrl.abort(); } catch (_) {} }, timeoutMs);
    const r = await fetch(url, { method: 'HEAD', redirect: 'follow', signal: ctrl.signal, headers: { 'User-Agent': 'Mozilla/5.0' } });
    clearTimeout(t);
    const ct = String(r.headers.get('content-type') || '');
    return /^image\//i.test(ct);
  } catch (_) { return false; }
}
// Attempt to download image bytes and return an Attachment for Discord embeds
async function tryCreateImageAttachmentFromUrl(url, opts) {
  const options = opts || {};
  const timeoutMs = Number(options.timeoutMs || 3000);
  const maxBytes = Number(options.maxBytes || 7500000); // ~7.5MB safe default
  try {
    console.log('[IMG-DL] Attempt download:', url);
    // Tenor blocks HEAD requests (returns 404) but allows GET
    const skipHead = url.includes('tenor.com') || url.includes('giphy.com');
    
    if (skipHead) {
      console.log('[IMG-DL] Skipping HEAD for Tenor/Giphy');
      // Download directly without HEAD check
      const ctrl2 = new AbortController();
      const t2 = setTimeout(() => { try { ctrl2.abort(); } catch (_) {} }, timeoutMs);
      const r = await fetch(url, { method: 'GET', redirect: 'follow', signal: ctrl2.signal, headers: { 'User-Agent': 'Mozilla/5.0', 'Accept': 'image/*' } });
      console.log('[IMG-DL] GET response status:', r.status, r.ok ? 'OK' : 'NOT OK');
      clearTimeout(t2);
      if (!r.ok) {
        console.log('[IMG-DL] ‚ùå GET failed, status:', r.status);
        return null;
      }
      const ct = String(r.headers.get('content-type') || '');
      if (!/^image//i.test(ct)) {
        console.log('[IMG-DL] Not an image, content-type:', ct);
        return null;
      }
      console.log('[IMG-DL] Downloading array buffer...');
      const ab = await r.arrayBuffer();
      console.log('[IMG-DL] Downloaded:', ab.byteLength, 'bytes');
      const size = ab.byteLength || 0;
      if (size <= 0 || size > maxBytes) {
        console.log('[IMG-DL] Size invalid:', size);
        return null;
      }
      const ext = (() => {
        if (/gif/i.test(ct)) return 'gif';
        if (/png/i.test(ct)) return 'png';
        if (/jpe?g/i.test(ct)) return 'jpg';
        if (/webp/i.test(ct)) return 'webp';
        return 'img';
      })();
      const fileName = `action-media.${ext}`;
      const { AttachmentBuilder } = require('discord.js');
      const buffer = Buffer.from(ab);
      console.log('[IMG-DL] ‚úÖ Success:', size, 'bytes');
      return { attachment: new AttachmentBuilder(buffer, { name: fileName }), filename: fileName };
    }
    
    // Standard path with HEAD check for other URLs
    const ctrl = new AbortController();
    const t = setTimeout(() => { try { ctrl.abort(); } catch (_) {} }, timeoutMs);
    const head = await fetch(url, { method: 'HEAD', redirect: 'follow', signal: ctrl.signal, headers: { 'User-Agent': 'Mozilla/5.0', 'Accept': 'image/*' } }).catch(()=>null);
    clearTimeout(t);
    const contentType = String(head?.headers?.get?.('content-type') || '');
    const isImage = /^image\//i.test(contentType);
    if (!isImage) return null;
    const lenHeader = head?.headers?.get?.('content-length');
    if (lenHeader && Number(lenHeader) > maxBytes) return null;
    const ctrl2 = new AbortController();
    const t2 = setTimeout(() => { try { ctrl2.abort(); } catch (_) {} }, timeoutMs);
    const r = await fetch(url, { method: 'GET', redirect: 'follow', signal: ctrl2.signal, headers: { 'User-Agent': 'Mozilla/5.0', 'Accept': 'image/*' } });
    clearTimeout(t2);
    if (!r.ok) return null;
    const ct = String(r.headers.get('content-type') || contentType || '');
    if (!/^image\//i.test(ct)) return null;
    const ab = await r.arrayBuffer();
    const size = ab.byteLength || 0;
    if (size <= 0 || size > maxBytes) return null;
    const ext = (() => {
      if (/gif/i.test(ct)) return 'gif';
      if (/png/i.test(ct)) return 'png';
      if (/jpe?g/i.test(ct)) return 'jpg';
      if (/webp/i.test(ct)) return 'webp';
      return 'img';
    })();
    const fileName = `action-media.${ext}`;
    const buffer = Buffer.from(ab);
    return { attachment: new AttachmentBuilder(buffer, { name: fileName }), filename: fileName };
  } catch (_) {
    return null;
  }
}
// Geocoding via LocationIQ and distance computations for /map, /proche, /localisation
async function geocodeCityToCoordinates(cityQuery) {
  const token = process.env.LOCATIONIQ_TOKEN || '';
  if (!token) return null;
  try {
    const q = encodeURIComponent(String(cityQuery||'').trim());
    if (!q) return null;
    const endpoint = `https://eu1.locationiq.com/v1/search?key=${token}&q=${q}&format=json&limit=1&normalizecity=1&accept-language=fr`;
    const r = await fetch(endpoint);
    if (!r.ok) return null;
    const arr = await r.json();
    if (!Array.isArray(arr) || !arr.length) return null;
    const it = arr[0] || {};
    const lat = Number(it.lat || it.latitude || 0);
    const lon = Number(it.lon || it.longitude || 0);
    if (!isFinite(lat) || !isFinite(lon)) return null;
    const display = String(it.display_name || it.address?.city || it.address?.town || it.address?.village || cityQuery).trim();
    return { lat, lon, displayName: display };
  } catch (_) {
    return null;
  }
}
function toRad(deg) {
  return (deg * Math.PI) / 180;
}
function haversineDistanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return Math.round(R * c);
}
function zoomForRadiusKm(radiusKm) {
  if (radiusKm <= 20) return 11;
  if (radiusKm <= 50) return 10;
  if (radiusKm <= 100) return 9;
  if (radiusKm <= 200) return 8;
  if (radiusKm <= 400) return 7;
  if (radiusKm <= 800) return 6;
  return 5;
}
async function fetchStaticMapBuffer(centerLat, centerLon, zoom, markerList, width = 800, height = 500) {
  const token = process.env.LOCATIONIQ_TOKEN || '';
  const liqUrl = (() => {
    if (!token) return null;
    let u = `https://maps.locationiq.com/v3/staticmap?key=${encodeURIComponent(token)}&center=${encodeURIComponent(String(centerLat))},${encodeURIComponent(String(centerLon))}&zoom=${encodeURIComponent(String(zoom))}&size=${encodeURIComponent(String(width))}x${encodeURIComponent(String(height))}&format=png`;
    const safe = Array.isArray(markerList) ? markerList.filter(m => isFinite(Number(m.lat)) && isFinite(Number(m.lon))) : [];
    if (safe.length) {
      const parts = safe.map(m => `icon:${encodeURIComponent(m.icon || 'small-red-cutout')}|${encodeURIComponent(String(Number(m.lat)))},${encodeURIComponent(String(Number(m.lon)))}`);
      u += `&markers=${parts.join('|')}`;
    }
    return u;
  })();
  const osmUrl = (() => {
    // Fallback provider (no token required)
    let u = `https://staticmap.openstreetmap.de/staticmap.php?center=${encodeURIComponent(String(centerLat))},${encodeURIComponent(String(centerLon))}&zoom=${encodeURIComponent(String(zoom))}&size=${encodeURIComponent(String(width))}x${encodeURIComponent(String(height))}`;
    const safe = Array.isArray(markerList) ? markerList.filter(m => isFinite(Number(m.lat)) && isFinite(Number(m.lon))) : [];
    if (safe.length) {
      const parts = safe.map(m => `${encodeURIComponent(String(Number(m.lat)))},${encodeURIComponent(String(Number(m.lon)))},${encodeURIComponent((m.icon && String(m.icon).includes('blue')) ? 'blue-pushpin' : 'red-pushpin')}`);
      u += `&markers=${parts.join('|')}`;
    }
    return u;
  })();
  const tryFetch = async (url) => {
    if (!url) return null;
    try {
      const r = await fetch(url);
      if (!r.ok) return null;
      const ab = await r.arrayBuffer();
      return Buffer.from(ab);
    } catch (_) { return null; }
  };
  // Try LocationIQ first, then OSM
  const buf1 = await tryFetch(liqUrl);
  if (buf1) return buf1;
  return await tryFetch(osmUrl);
}
function buildStaticMapUrl(centerLat, centerLon, zoom, markerList, width = 800, height = 500) {
  const token = process.env.LOCATIONIQ_TOKEN || '';
  if (token) {
    let u = `https://maps.locationiq.com/v3/staticmap?key=${encodeURIComponent(token)}&center=${encodeURIComponent(String(centerLat))},${encodeURIComponent(String(centerLon))}&zoom=${encodeURIComponent(String(zoom))}&size=${encodeURIComponent(String(width))}x${encodeURIComponent(String(height))}&format=png`;
    const safe = Array.isArray(markerList) ? markerList.filter(m => isFinite(Number(m.lat)) && isFinite(Number(m.lon))) : [];
    if (safe.length) {
      const parts = safe.map(m => `icon:${encodeURIComponent(m.icon || 'small-red-cutout')}|${encodeURIComponent(String(Number(m.lat)))},${encodeURIComponent(String(Number(m.lon)))}`);
      u += `&markers=${parts.join('|')}`;
    }
    return u;
  }
  // Fallback OSM URL if no token
  let u = `https://staticmap.openstreetmap.de/staticmap.php?center=${encodeURIComponent(String(centerLat))},${encodeURIComponent(String(centerLon))}&zoom=${encodeURIComponent(String(zoom))}&size=${encodeURIComponent(String(width))}x${encodeURIComponent(String(height))}`;
  const safe = Array.isArray(markerList) ? markerList.filter(m => isFinite(Number(m.lat)) && isFinite(Number(m.lon))) : [];
  if (safe.length) {
    const parts = safe.map(m => `${encodeURIComponent(String(Number(m.lat)))},${encodeURIComponent(String(Number(m.lon)))},${encodeURIComponent((m.icon && String(m.icon).includes('blue')) ? 'blue-pushpin' : 'red-pushpin')}`);
    u += `&markers=${parts.join('|')}`;
  }
  return u;
}
try { require('dotenv').config({ override: true, path: '/var/data/.env' }); } catch (_) { try { require('dotenv').config({ override: true }); } catch (_) {} }

const token = process.env.DISCORD_TOKEN;
const guildId = process.env.GUILD_ID;


// RENDER OPTIMIZATION: D√©tection et optimisation environnement Render
const isRenderEnvironment = process.env.RENDER || process.env.RENDER_SERVICE_ID || process.env.RENDER_EXTERNAL_URL;
if (isRenderEnvironment) {
  console.log('[RENDER-OPT] Environnement Render d√©tect√© - Optimisations activ√©es');
  
  // R√©duire les timeouts par d√©faut
  process.env.DEFAULT_TIMEOUT = '1500';
  process.env.NETWORK_TIMEOUT = '2000';
  process.env.INTERACTION_TIMEOUT = '2500';
  
  // Optimiser la garbage collection
  if (global.gc) {
    setInterval(() => {
      try { global.gc(); } catch (_) {}
    }, 30000);
  }
}

// RENDER OPTIMIZATION: Fallbacks pour op√©rations critiques
const renderSafeReply = async (interaction, content, options = {}) => {
  const payload = typeof content === 'string' ? { content, ...options } : content;
  
  try {
    if (interaction.deferred) {
      return await interaction.editReply(payload);
    } else if (!interaction.replied) {
      return await interaction.reply(payload);
    } else {
      return await interaction.followUp(payload);
    }
  } catch (error) {
    console.error('[RENDER-SAFE] Reply failed:', error.message);
    // Derni√®re tentative avec followUp
    try {
      if (!interaction.replied) {
        return await interaction.reply({ content: '‚ö†Ô∏è R√©ponse avec d√©lai', ephemeral: true });
      }
    } catch (_) {
      console.error('[RENDER-SAFE] All reply methods failed');
    }
  }
};

// RENDER OPTIMIZATION: D√©f√©rer imm√©diatement TOUTES les interactions
async function immediatelyDeferInteraction(interaction, actionType = 'command') {
  if (!interaction.deferred && !interaction.replied) {
    try {
      await interaction.deferReply();
      console.log(`[RENDER-OPT] Interaction ${actionType} d√©f√©r√©e imm√©diatement`);
      return true;
    } catch (error) {
      console.warn(`[RENDER-OPT] √âchec defer ${actionType}:`, error.message);
      return false;
    }
  }
  return interaction.deferred;
}

// Interaction monitoring for debugging stuck interactions
const pendingInteractions = new Map();

function trackInteraction(interaction, actionType = 'unknown') {
  const key = `${interaction.id}-${interaction.user.id}`;
  pendingInteractions.set(key, {
    id: interaction.id,
    userId: interaction.user.id,
    actionType,
    timestamp: Date.now(),
    deferred: interaction.deferred,
    replied: interaction.replied
  });
  
  // Auto-cleanup after 30 seconds
  setTimeout(() => {
    if (pendingInteractions.has(key)) {
      console.warn(`[Monitor] Interaction ${actionType} from ${interaction.user.tag || interaction.user.id} timed out after 30s`);
      pendingInteractions.delete(key);
    }
  }, 2000);
}

function untrackInteraction(interaction) {
  const key = `${interaction.id}-${interaction.user.id}`;
  pendingInteractions.delete(key);
}
// Fonction pour trouver le fichier logo (avec ou sans majuscule)
function findLogoPath() {
  const fs = require('fs');
  const possiblePaths = ['./Bag.png', './bag.png', './BAG.png'];
  for (const path of possiblePaths) {
    if (fs.existsSync(path)) {
      console.log('[Logo] Fichier logo trouv√©:', path);
      return path;
    }
  }
  console.log('[Logo] Aucun fichier logo trouv√©, utilisation du fallback');
  return null;
}

const LOGO_PATH = findLogoPath();
const CERTIFIED_LOGO_URL = process.env.CERTIFIED_LOGO_URL || LOGO_PATH;
const CERTIFIED_ROSEGOLD = String(process.env.CERTIFIED_ROSEGOLD || 'false').toLowerCase() === 'true';
const LEVEL_CARD_LOGO_URL = process.env.LEVEL_CARD_LOGO_URL || LOGO_PATH;

// Ticket banner helper (bag2)
function findTicketBannerPath() {
  try {
    const fs = require('fs');
    const possible = ['./bag2.png', './Bag2.png', './BAG2.png'];
    for (const p of possible) {
      if (fs.existsSync(p)) {
        try { console.log('[Tickets] Banni√®re trouv√©e:', p); } catch (_) {}
        return p;
      }
    }
  } catch (_) {}
  try { console.warn('[Tickets] Aucune banni√®re bag2.png trouv√©e'); } catch (_) {}
  return null;
}
const TICKET_BANNER_PATH = findTicketBannerPath();
function maybeAttachTicketBanner(embed, bannerUrl) {
  // Si une bannerUrl personnalis√©e est fournie, l'utiliser
  if (bannerUrl) {
    if (embed && typeof embed.setImage === 'function') {
      embed.setImage(bannerUrl);
    }
    return null; // Pas d'attachment, l'URL suffit
  }
  // Sinon, banni√®re globale d√©sactiv√©e
  return null;
}

if (!token || !guildId) {
  console.error('Missing DISCORD_TOKEN or GUILD_ID in environment');
  process.exit(2);
}

// Helper: Trouver une suite par channelId
function findSuiteByChannel(eco, channelId) {
  if (!eco.suites?.active) return null;
  for (const [userId, suites] of Object.entries(eco.suites.active)) {
    const suitesArray = Array.isArray(suites) ? suites : [suites];
    for (const suite of suitesArray) {
      if (suite.textId === channelId || suite.voiceId === channelId) {
        return { userId, suite };
      }
    }
  }
  return null;
}

// Helper: Obtenir toutes les suites d'un utilisateur
function getUserSuites(eco, userId) {
  if (!eco.suites?.active?.[userId]) return [];
  const suites = eco.suites.active[userId];
  return Array.isArray(suites) ? suites : [suites];
}



// Helper: V√©rifier qu'un membre est valide et pr√©sent sur le serveur
async function validateAndFetchMember(guild, userId) {
  try {
    const member = await guild.members.fetch(userId);
    return member && !member.user.bot ? member : null;
  } catch (error) {
    console.log(`[Member Validation] Member ${userId} not found or left server`);
    return null;
  }
}

// Helper: Envoyer l'embed de bienvenue dans une suite et l'√©pingler
async function sendSuiteWelcomeEmbed(textChannel, voiceChannelId, userId, expiresAt) {
  try {
    const expirationText = expiresAt 
      ? `<t:${Math.floor(expiresAt/1000)}:R>` 
      : '‚ôæÔ∏è Permanente';
    
    const embed = new EmbedBuilder()
      .setTitle('üè† Suite Priv√©e - Gestion des Membres')
      .setDescription(`Bienvenue dans votre suite priv√©e !\n\nUtilisez les boutons ci-dessous pour g√©rer l'acc√®s √† vos canaux de suite.`)
      .addFields([
        { name: 'üìù Canal Texte', value: `<#${textChannel.id}>`, inline: true },
        { name: 'üîä Canal Vocal', value: `<#${voiceChannelId}>`, inline: true },
        { name: '‚è∞ Expiration', value: expirationText, inline: true }
      ])
      .setColor(0x7289DA)
      .setFooter({ text: 'Cliquez sur les boutons pour inviter ou retirer des membres' });
    
    const row = new ActionRowBuilder()
      .addComponents(
        new ButtonBuilder()
          .setCustomId(`suite_invite_${userId}`)
          .setLabel('‚ûï Inviter un membre')
          .setStyle(ButtonStyle.Success),
        new ButtonBuilder()
          .setCustomId(`suite_remove_${userId}`)
          .setLabel('‚ûñ Retirer un membre')
          .setStyle(ButtonStyle.Danger),
        new ButtonBuilder()
          .setCustomId(`suite_list_${userId}`)
          .setLabel('üìã Liste des membres')
          .setStyle(ButtonStyle.Secondary)
      );
    
    const message = await textChannel.send({
      content: `<@${userId}> Votre suite priv√©e est pr√™te !`,
      embeds: [embed],
      components: [row]
    });
    
    // √âpingler le message
    await message.pin();
    console.log(`[Suite] ‚úÖ Embed envoy√© et √©pingl√© dans ${textChannel.name}`);
    
    return message;
  } catch (error) {
    console.error(`[Suite] ‚ùå Erreur envoi embed:`, error);
    return null;
  }
}

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildVoiceStates,
    GatewayIntentBits.GuildMembers,
  ],
  partials: [Partials.GuildMember, Partials.Message, Partials.Channel],
});
// Fonction pour envoyer des logs d√©taill√©s de sauvegarde
async function sendDetailedBackupLog(guild, info, method, user) {
  try {
    const lc = await getLogsConfig(guild.id);
    if (!lc?.categories?.backup) return;

    const timestamp = new Date(info.details?.timestamp || new Date()).toLocaleString('fr-FR');
    
    // D√©terminer le statut global
    const localSuccess = info.local?.success;
    const githubSuccess = info.github?.success;
    const githubConfigured = info.github?.configured;
    
    let globalStatus = '‚ùå √âchec';
    let statusColor = 0xff4444; // Rouge
    
    if (localSuccess && githubSuccess) {
      globalStatus = '‚úÖ Succ√®s complet';
      statusColor = 0x44ff44; // Vert
    } else if (localSuccess && !githubConfigured) {
      globalStatus = '‚ö†Ô∏è Succ√®s partiel';
      statusColor = 0xffaa44; // Orange
    } else if (localSuccess) {
      globalStatus = '‚ö†Ô∏è Local OK, GitHub KO';
      statusColor = 0xffaa44; // Orange
    }

    // Construire l'embed principal
    const embed = {
      title: `${lc.emoji} Sauvegarde ${globalStatus}`,
      description: `**M√©thode:** ${method}${user ? `\n**Auteur:** ${user}` : ''}`,
      color: statusColor,
      timestamp: new Date().toISOString(),
      fields: []
    };

    // Informations g√©n√©rales
    if (info.details) {
      embed.fields.push({
        name: 'üìä Donn√©es sauvegard√©es',
        value: [
          `üìÅ Serveurs: ${info.details.guildsCount || 0}`,
          `üë• Utilisateurs: ${info.details.usersCount || 0}`,
          `üíæ Taille: ${Math.round((info.details.dataSize || 0) / 1024)} KB`,
          `‚è∞ ${timestamp}`
        ].join('\n'),
        inline: false
      });
    }

    // Statut sauvegarde locale
    const localIcon = localSuccess ? '‚úÖ' : '‚ùå';
    const localType = info.storage === 'postgres' ? 'PostgreSQL' : info.storage === 'http' ? 'HTTP Export' : 'Fichier';
    let localValue = `${localIcon} ${localType}`;
    
    if (localSuccess) {
      if (info.historyId) localValue += `\nüìù ID: ${info.historyId}`;
      if (info.backupFile) localValue += `\nüìÑ Fichier cr√©√©`;
    } else if (info.local?.error) {
      localValue += `\nüí• ${info.local.error}`;
    }

    embed.fields.push({
      name: 'üè† Sauvegarde Locale',
      value: localValue,
      inline: true
    });

    // Statut sauvegarde GitHub
    const githubIcon = githubSuccess ? '‚úÖ' : (githubConfigured ? '‚ùå' : '‚öôÔ∏è');
    let githubValue = `${githubIcon} GitHub`;
    
    if (!githubConfigured) {
      githubValue += '\n‚öôÔ∏è Non configur√©';
    } else if (githubSuccess) {
      githubValue += `\nüîó ${info.github.commit_sha.substring(0, 7)}`;
      if (info.github.commit_url) githubValue += `\n[Voir commit](${info.github.commit_url})`;
    } else if (info.github?.error) {
      githubValue += `\nüí• ${info.github.error.substring(0, 100)}`;
    }

    embed.fields.push({
      name: 'üêô Sauvegarde GitHub',
      value: githubValue,
      inline: true
    });

    // Recommandations si probl√®mes
    if (!githubConfigured) {
      embed.fields.push({
        name: 'üí° Configuration GitHub',
        inline: false
      });
    } else if (!githubSuccess && githubConfigured) {
      embed.fields.push({
        name: 'üîß D√©pannage',
        value: 'V√©rifiez:\n‚Ä¢ Token GitHub valide\n‚Ä¢ Permissions du d√©p√¥t\n‚Ä¢ Connexion r√©seau\n\nUtilisez `/github-backup test`',
        inline: false
      });
    }

    await sendLog(guild, 'backup', embed);
  } catch (error) {
    console.error('[BackupLog] Erreur envoi log:', error.message);
  }
}

// Fonction pour envoyer des logs d√©taill√©s de restauration
async function sendDetailedRestoreLog(guild, result, method, user) {
  try {
    const lc = await getLogsConfig(guild.id);
    if (!lc?.categories?.backup) return;

    const sourceLabels = {
      'github': { icon: 'üêô', name: 'GitHub', color: 0x6cc644 },
      'postgres_history': { icon: 'üêò', name: 'PostgreSQL (Historique)', color: 0x336791 },
      'postgres_current': { icon: 'üêò', name: 'PostgreSQL (Actuel)', color: 0x336791 },
      'file_backup': { icon: 'üìÅ', name: 'Fichier (Backup)', color: 0xffa500 },
      'file_current': { icon: 'üìÅ', name: 'Fichier (Actuel)', color: 0xffa500 },
      'default': { icon: 'üîß', name: 'Configuration par d√©faut', color: 0x999999 }
    };

    const sourceInfo = sourceLabels[result?.source] || { icon: '‚ùì', name: 'Source inconnue', color: 0xff4444 };
    const success = result?.ok;

    const embed = {
      title: `${lc.emoji} Restauration ${success ? '‚úÖ R√©ussie' : '‚ùå √âchou√©e'}`,
      description: `**M√©thode:** ${method}${user ? `\n**Auteur:** ${user}` : ''}`,
      color: success ? sourceInfo.color : 0xff4444,
      timestamp: new Date().toISOString(),
      fields: [
        {
          name: 'üì• Source de restauration',
          value: `${sourceInfo.icon} ${sourceInfo.name}`,
          inline: true
        },
        {
          name: 'üìä Statut',
          value: success ? '‚úÖ Donn√©es restaur√©es' : '‚ùå √âchec de restauration',
          inline: true
        }
      ]
    };

    // Ajouter des d√©tails selon la source
    if (success) {
      switch (result.source) {
        case 'github':
          embed.fields.push({
            name: 'üêô D√©tails GitHub',
            value: '‚úÖ Restauration depuis la sauvegarde GitHub\nüîÑ Synchronisation locale effectu√©e',
            inline: false
          });
          break;
        case 'postgres_history':
        case 'postgres_current':
          embed.fields.push({
            name: 'üêò D√©tails PostgreSQL',
            value: '‚úÖ Restauration depuis la base de donn√©es\nüîÑ Synchronisation fichier effectu√©e',
            inline: false
          });
          break;
        case 'file_backup':
        case 'file_current':
          embed.fields.push({
            name: 'üìÅ D√©tails Fichier',
            value: '‚úÖ Restauration depuis fichier local\n‚ö†Ô∏è Consid√©rez configurer GitHub pour plus de s√©curit√©',
            inline: false
          });
          break;
        case 'default':
          embed.fields.push({
            name: 'üîß Configuration par d√©faut',
            value: '‚ö†Ô∏è Aucune sauvegarde trouv√©e\nüÜï Configuration vierge appliqu√©e',
            inline: false
          });
          break;
      }
    }

    // Recommandations selon la source utilis√©e
    if (success && result.source !== 'github') {
      embed.fields.push({
        name: 'üí° Recommandation',
        inline: false
      });
    }

    await sendLog(guild, 'backup', embed);
  } catch (error) {
    console.error('[RestoreLog] Erreur envoi log:', error.message);
  }
}

// Keepalive HTTP server for Render Web Services (bind PORT)
function startKeepAliveServer() {
  const port = Number(process.env.PORT || 0);
  if (!port) return;
  try {
    const http = require('http');
    const server = http.createServer((req, res) => {
      res.writeHead(200, { 'Content-Type': 'text/plain' });
      if (req.url === '/health') return res.end('OK');
      if (req.url === '/backup') {
        const token = process.env.BACKUP_TOKEN || '';
        const auth = req.headers['authorization'] || '';
        if (token && auth !== `Bearer ${token}`) { res.statusCode = 401; return res.end('Unauthorized'); }
        try {
          const { readConfig, paths } = require('./storage/jsonStore');
          readConfig().then(async (cfg) => {
            const text = JSON.stringify(cfg, null, 2);
            res.setHeader('Content-Type', 'application/json');
            res.end(text);
            // Log success to configured logs channel
            try {
              const g = client.guilds.cache.get(guildId) || await client.guilds.fetch(guildId).catch(()=>null);
              if (g) {
                // Simuler les infos de backup pour HTTP (pas de donn√©es d√©taill√©es disponibles ici)
                const httpInfo = { 
                  storage: 'http', 
                  local: { success: true }, 
                  github: { success: false, configured: false, error: 'Non disponible via HTTP' },
                  details: { timestamp: new Date().toISOString() }
                };
                await sendDetailedBackupLog(g, httpInfo, 'http', null);
              }
            } catch (_) {}
          }).catch(() => { res.statusCode = 500; res.end('ERR'); });
        } catch (_) { res.statusCode = 500; res.end('ERR'); }
        return;
      }
      return res.end('BAG bot running');
    });
    server.listen(port, '0.0.0.0', () => {
      try { console.log(`[KeepAlive] listening on ${port}`); } catch (_) {}
    });
  } catch (e) {
    try { console.error('[KeepAlive] failed:', e?.message || e); } catch (_) {}
  }
}
startKeepAliveServer();


const THEME_COLOR_PRIMARY = 0x1e88e5; // blue
const THEME_COLOR_ACCENT = 0xec407a; // pink
const THEME_COLOR_NSFW = 0xd32f2f; // deep red for NSFW
const THEME_IMAGE = 'https://cdn.discordapp.com/attachments/1408458115283812484/1408497858256179400/file_00000000d78861f4993dddd515f84845.png?ex=68b08cda&is=68af3b5a&hm=2e68cb9d7dfc7a60465aa74447b310348fc2d7236e74fa7c08f9434c110d7959&';
const THEME_FOOTER_ICON = 'https://cdn.discordapp.com/attachments/1408458115283812484/1408458115770482778/20250305162902.png?ex=68b50516&is=68b3b396&hm=1d83bbaaa9451ed0034a52c48ede5ddc55db692b15e65b4fe5c659ed4c80b77d&';
let THEME_TICKET_FOOTER_ICON = 'https://cdn.discordapp.com/attachments/1408458115283812484/1411752143173714040/IMG_20250831_183646.png?ex=68b7c664&is=68b674e4&hm=5980bdf7a118bddd76bb4d5f57168df7b2986b23b56ff0c96d47c3827b283765&';
// Variables dynamiques pour les th√®mes personnalis√©s (charg√©es au d√©marrage depuis le storage)
let currentThumbnailImage = THEME_IMAGE;
const categoryBanners = { moderation: null, economy: null, localisation: null, confessions: null, premium_suites: null, comptage: null, couleurs: null, top_leaderboards: null, configuration: null, pagination: null };
let currentFooterIcon = THEME_FOOTER_ICON;


const DELAY_OPTIONS = [
  { label: '15 minutes', ms: 15 * 60 * 1000 },
  { label: '1 heure', ms: 60 * 60 * 1000 },
  { label: '6 heures', ms: 6 * 60 * 60 * 1000 },
  { label: '24 heures', ms: 24 * 60 * 60 * 1000 },
  { label: '2 jours', ms: 2 * 24 * 60 * 60 * 1000 },
  { label: '3 jours', ms: 3 * 24 * 60 * 60 * 1000 },
  { label: '7 jours', ms: 7 * 24 * 60 * 60 * 1000 },
];

const MIN_DELAY_MS = Math.min(...DELAY_OPTIONS.map(d => d.ms));
const MAX_DELAY_MS = Math.max(...DELAY_OPTIONS.map(d => d.ms));

function formatDuration(ms) {
  const sec = Math.round(ms / 1000);
  if (sec < 3600) return `${Math.round(sec / 60)} min`;
  if (sec < 86400) return `${Math.round(sec / 3600)} h`;
  return `${Math.round(sec / 86400)} j`;
}

async function isStaffMember(guild, member) {
  try {
    const { getGuildStaffRoleIds } = require('./storage/jsonStore');
    const staffRoleIds = await getGuildStaffRoleIds(guild.id);
    if (Array.isArray(staffRoleIds) && staffRoleIds.length) {
      return Boolean(member?.roles?.cache?.some(r => staffRoleIds.includes(r.id)));
    }
  } catch (_) {}
  // Fallback: use Discord permissions for moderation
  return member?.permissions?.has?.(PermissionsBitField.Flags.ModerateMembers) || false;
}

function buildModEmbed(title, description, extras) {
  const embed = new EmbedBuilder()
    .setColor(THEME_COLOR_ACCENT)
    .setTitle(title)
    .setDescription(description || null)
    .setThumbnail(currentThumbnailImage)
    .setTimestamp(new Date())
    .setFooter({ text: 'BAG ‚Ä¢ Mod√©ration', iconURL: currentFooterIcon });
  try { if (embed?.data?.footer?.text || true) embed.setFooter({ text: embed?.data?.footer?.text || 'Boy and Girls (BAG)', iconURL: currentFooterIcon }); } catch (_) {}
  if (Array.isArray(extras) && extras.length) embed.addFields(extras);
  // Ajouter la banni√®re si configur√©e
  if (categoryBanners.moderation) embed.setImage(categoryBanners.moderation);
  return embed;
}

function buildEcoEmbed(opts) {
  const { title, description, fields, color } = opts || {};
  const embed = new EmbedBuilder()
    .setColor(color || THEME_COLOR_PRIMARY)
    .setThumbnail(currentThumbnailImage)
    .setTimestamp(new Date())
    .setFooter({ text: 'BAG ‚Ä¢ √âconomie', iconURL: currentFooterIcon });
  if (title) embed.setTitle(String(title));
  if (description) embed.setDescription(String(description));
  if (Array.isArray(fields) && fields.length) embed.addFields(fields);
  // Ajouter la banni√®re si configur√©e
  if (categoryBanners.economy) embed.setImage(categoryBanners.economy);
  return embed;
}

// Embeds ‚Äî Action/V√©rit√© (Pro & Premium styles)
function buildTruthDareStartEmbed(mode, hasAction, hasTruth) {
  const isNsfw = String(mode||'').toLowerCase() === 'nsfw';
  const color = isNsfw ? THEME_COLOR_NSFW : THEME_COLOR_ACCENT;
  const title = isNsfw ? 'üîû Action ou V√©rit√© (NSFW)' : 'üé≤ Action ou V√©rit√©';
  const footerText = isNsfw ? 'BAG ‚Ä¢ Premium' : 'BAG ‚Ä¢ Pro';
  const lines = [];
  if (hasAction && hasTruth) lines.push('Choisissez votre destin‚Ä¶');
  else if (hasAction) lines.push('Appuyez sur ACTION pour commencer.');
  else if (hasTruth) lines.push('Appuyez sur V√âRIT√â pour commencer.');
  lines.push('Cliquez pour un nouveau prompt √† chaque tour.');
  const embed = new EmbedBuilder()
    .setColor(color)
    .setAuthor({ name: 'Action/V√©rit√© ‚Ä¢ Boy and Girls (BAG)' })
    .setTitle(title)
    .setDescription(lines.join('\n'))
    .setThumbnail(currentThumbnailImage)
    .setTimestamp(new Date())
    .setFooter({ text: footerText, iconURL: currentFooterIcon });
  return embed;
}

function buildTruthDarePromptEmbed(mode, type, text) {
  const isNsfw = String(mode||'').toLowerCase() === 'nsfw';
  const footerText = isNsfw ? 'BAG ‚Ä¢ Premium' : 'BAG ‚Ä¢ Pro';
  let color = isNsfw ? THEME_COLOR_NSFW : THEME_COLOR_PRIMARY;
  if (String(type||'').toLowerCase() === 'verite') color = isNsfw ? THEME_COLOR_NSFW : THEME_COLOR_ACCENT;
  const title = String(type||'').toLowerCase() === 'action' ? 'üî• ACTION' : 'üéØ V√âRIT√â';
  const embed = new EmbedBuilder()
    .setColor(color)
    .setAuthor({ name: 'Action/V√©rit√© ‚Ä¢ Boy and Girls (BAG)' })
    .setTitle(title)
    .setDescription(`${String(text||'‚Äî')}\n\nCliquez pour un nouveau prompt.`)
    .setThumbnail(currentThumbnailImage)
    .setTimestamp(new Date())
    .setFooter({ text: footerText, iconURL: currentFooterIcon });
  return embed;
}

// Karma grants helper: evaluate configured grant rules and compute extra money
function evaluateKarmaCondition(conditionExpr, charm, perversion, amount) {
  try {
    // Normalize common French aliases to internal vars
    let expr = String(conditionExpr || '').trim();
    expr = expr.replace(/\bcharme\b/gi, 'charm');
    expr = expr.replace(/\bCharm\b/g, 'charm'); // Fix case-sensitivity bug!
    expr = expr.replace(/\bPerversion\b/g, 'perversion'); // Fix case-sensitivity bug!
    expr = expr.replace(/\bAmount\b/g, 'amount'); // Fix case-sensitivity bug!
    expr = expr.replace(/\bargent\b/gi, 'amount');
    expr = expr.replace(/\bsolde\b/gi, 'amount');
    expr = expr.replace(/\bperversit√©\b/gi, 'perversion');
    expr = expr.replace(/\bperversite\b/gi, 'perversion');
    // Admin-provided simple expressions like "charm>=100 && perversion<50"
    // Only expose numeric variables; no other scope
    // eslint-disable-next-line no-new-func
    const fn = new Function('charm', 'perversion', 'amount', `return ( ${expr} );`);
    return !!fn(Number(charm || 0), Number(perversion || 0), Number(amount || 0));
  } catch (_) {
    return false;
  }
}

function calculateKarmaGrants(grantRules, charm, perversion, amount, actionKey) {
  if (!Array.isArray(grantRules)) return 0;
  let total = 0;
  for (const rule of grantRules) {
    if (!rule || typeof rule !== 'object') continue;
    if (typeof rule.condition !== 'string') continue;
    if (typeof rule.money !== 'number') continue;
    // Optionnel: limiter √† certaines actions si rule.actions est d√©fini
    if (Array.isArray(rule.actions) && rule.actions.length) {
      const ak = String(actionKey || '').toLowerCase();
      const allow = rule.actions.map(v => String(v || '').toLowerCase());
      if (!allow.includes(ak)) continue;
    }
    if (evaluateKarmaCondition(rule.condition, charm, perversion, amount)) {
      total += rule.money;
    }
  }
  return total;
}

async function maybeAwardOneTimeGrant(interaction, eco, userEcoAfter, actionKey, prevCharm, prevPerversion, prevAmount) {
  try {
    console.log(`[GRANT DEBUG] Checking grants for ${interaction.user.tag} - Action: ${actionKey}`);
    console.log(`[GRANT DEBUG] Karma: charm ${prevCharm} ‚Üí ${userEcoAfter.charm}, perversion ${prevPerversion} ‚Üí ${userEcoAfter.perversion}`);
    const grants = Array.isArray(eco.karmaModifiers?.grants) ? eco.karmaModifiers.grants : [];
    if (!grants.length) {
      console.log('[GRANT DEBUG] No grants configured');
      return;
    }
    console.log(`[GRANT DEBUG] Found ${grants.length} grants configured`);
    // Espace de suivi: √©viter de redonner le m√™me grant plusieurs fois
    if (!client._ecoGrantGiven) client._ecoGrantGiven = new Map();
    if (!userEcoAfter || typeof userEcoAfter !== 'object') return;
    const keyBase = `${interaction.guild.id}:${interaction.user.id}`;
    // Collecter les r√®gles √©ligibles non encore attribu√©es
    // Si rule.scope === 'action', ne tester que sur action; si 'admin', ne tester que sur /adminkarma; sinon 'any'
    const candidates = [];
    for (let i = 0; i < grants.length; i++) {
      const rule = grants[i];
      console.log(`[GRANT DEBUG] Testing grant ${i}: ${rule?.name || 'unnamed'}`);
      if (!rule || typeof rule !== 'object') {
        console.log(`[GRANT DEBUG]   ‚ùå Skip: invalid rule`);
        continue;
      }
      const scope = String(rule.scope || 'any').toLowerCase();
      if (scope === 'action' && actionKey === 'adminkarma') {
        console.log(`[GRANT DEBUG]   ‚ùå Skip: scope=action but actionKey=adminkarma`);
        continue;
      }
      if (scope === 'admin' && actionKey !== 'adminkarma') {
        console.log(`[GRANT DEBUG]   ‚ùå Skip: scope=admin but actionKey=${actionKey}`);
        continue;
      }
      if (Array.isArray(rule.actions) && rule.actions.length) {
        const ak = String(actionKey || '').toLowerCase();
        const allow = rule.actions.map(v => String(v || '').toLowerCase());
        if (!allow.includes(ak)) {
          console.log(`[GRANT DEBUG]   ‚ùå Skip: action ${ak} not in allowed list [${allow.join(', ')}]`);
          continue;
        }
      }
      const cond = typeof rule.condition === 'string' ? rule.condition : '';
      const wasOk = evaluateKarmaCondition(cond, Number(prevCharm||0), Number(prevPerversion||0), Number(prevAmount||0));
      const nowOk = evaluateKarmaCondition(cond, userEcoAfter.charm || 0, userEcoAfter.perversion || 0, userEcoAfter.amount || 0);
      console.log(`[GRANT DEBUG]   Condition: ${cond} | wasOk=${wasOk} (charm=${prevCharm}) | nowOk=${nowOk} (charm=${userEcoAfter.charm})`);
      // Attribuer uniquement si la condition vient d'√™tre atteinte (franchissement de seuil) ou si thresholdCrossing est d√©sactiv√©
      const thresholdCrossing = rule.thresholdCrossing !== false; // par d√©faut true
      if (!nowOk) {
        console.log(`[GRANT DEBUG]   ‚ùå Skip: nowOk=false (condition not met)`);
        continue;
      }
      if (thresholdCrossing && wasOk) {
        console.log(`[GRANT DEBUG]   ‚ùå Skip: thresholdCrossing=true and wasOk=true (already above threshold)`);
        continue;
      }
      const money = Math.max(0, Number(rule.money || 0));
      if (!money) {
        console.log(`[GRANT DEBUG]   ‚ùå Skip: money=0`);
        continue;
      }
      // V√©rifier si grant d√©j√† re√ßu (persistant en DB) - utiliser i au lieu de idx
      if (!userEcoAfter.receivedGrants) userEcoAfter.receivedGrants = {};
      if (userEcoAfter.receivedGrants[i]) {
        console.log(`[GRANT DEBUG]   ‚ùå Skip: already received (receivedGrants[${i}]=${userEcoAfter.receivedGrants[i]})`);
        continue;
      }
      // Extraire un seuil si pr√©sent (charm>=N ou perversion>=N) pour ordonner
      let thr = Number.POSITIVE_INFINITY;
      try {
        const m1 = /charm\s*>=\s*(\d+)/i.exec(cond);
        const m2 = /perversion\s*>=\s*(\d+)/i.exec(cond);
        const t1 = m1 ? Number(m1[1]) : Number.POSITIVE_INFINITY;
        const t2 = m2 ? Number(m2[1]) : Number.POSITIVE_INFINITY;
        thr = Math.min(t1, t2);
      } catch (_) {}
      console.log(`[GRANT DEBUG]   ‚úÖ ELIGIBLE! money=${money}, threshold=${thr}`);
      candidates.push({ i, money, cond, thr });
    }
    console.log(`[GRANT DEBUG] Found ${candidates.length} eligible candidates`);
    if (!candidates.length) {
      console.log('[GRANT DEBUG] No eligible grants to award');
      return;
    }
    // N'attribuer qu'un seul grant par action: le plus faible seuil, sinon le plus petit montant
    candidates.sort((a, b) => (a.thr - b.thr) || (a.money - b.money));
    const pick = candidates[0];
    const idx = pick.i;
    const rule = grants[idx];
    const grantKey = `${keyBase}:grant:${idx}`;
    const money = pick.money;
    console.log(`[GRANT DEBUG] Awarding grant: ${rule.name} (+${money} BAG$)`);
    const beforeAmt = Number(userEcoAfter.amount || 0);
    const afterAmt = Math.max(0, beforeAmt + money);
    userEcoAfter.amount = afterAmt;
    // Marquer comme re√ßu AVANT de sauvegarder (persistant en DB)
    if (!userEcoAfter.receivedGrants) userEcoAfter.receivedGrants = {};
    userEcoAfter.receivedGrants[idx] = Date.now();
    await setEconomyUser(interaction.guild.id, interaction.user.id, userEcoAfter);
    // Embed s√©par√© avec informations du grant
    const currency = eco.currency?.name || 'BAG$';
    const grantName = rule.name || 'Grant';
    const grantDesc = rule.description || '';
    const embed = new EmbedBuilder()
      .setColor(0xFFD700) // Or
      .setTitle(`üéÅ ${grantName}`)
      .setDescription(grantDesc ? `*${grantDesc}*\n\nVous avez re√ßu **+${money} ${currency}** !` : `Vous avez re√ßu un grant de **+${money} ${currency}** !`)
      .addFields(
        { name: 'Condition remplie', value: pick.cond || '‚Äî', inline: false },
        { name: 'Nouveau solde', value: `${beforeAmt.toLocaleString()} ‚Üí **${afterAmt.toLocaleString()}** ${currency}`, inline: true },
      )
      .setThumbnail(currentThumbnailImage)
      .setFooter({ text: 'BAG ‚Ä¢ √âconomie ‚Ä¢ Grants', iconURL: currentFooterIcon })
      .setTimestamp(new Date());
    try {
      const mention = `<@${interaction.user.id}>`;
      if (interaction.channel && typeof interaction.channel.send === 'function') {
        await interaction.channel.send({ content: mention, embeds: [embed] });
      } else {
        await interaction.followUp({ content: mention, embeds: [embed] });
      }
    } catch (err) {
      console.error('[GRANT DEBUG] Error sending grant notification:', err.message);
    }
    console.log('[GRANT DEBUG] Grant successfully awarded and saved');
    // Log √©conomie
    try {
      const log = new EmbedBuilder()
        .setColor(0x3fb950)
        .setTitle('√âconomie ‚Ä¢ Grant attribu√©')
        .setDescription(`${interaction.user} a re√ßu +${money} ${currency}`)
        .addFields(
          { name: 'Condition', value: pick.cond || '‚Äî', inline: false },
          { name: 'Solde', value: `${beforeAmt} ‚Üí ${afterAmt} ${currency}`, inline: true }
        )
        .setTimestamp(new Date());
      await sendLog(interaction.guild, 'economy', log);
    } catch (_) {}
  } catch (_) {}
}
// Banque de messages √©rotiques enrichis pour certaines actions (fusionn√©s avec la config)
const eroticMsgBank = {
  kiss: {
    success: [
      'Tes l√®vres capturent celles de {cible}, chaleur imm√©diate, g√©missement √©touff√©.',
      'Un baiser vorace, {cible} se laisse d√©vorer.',
      'Tes langues s\‚Äôentr√®lacent, √©change humide, haletant.',
      'Un baiser lent, profond, vos corps s\‚Äôembrasent.',
      'Tu voles un baiser fougueux, {cible} accroche ta nuque.',
      'Tes l√®vres mordillent les siennes, {cible} frissonne.',
      'Vos bouches s\‚Äô√©crasent, respiration coup√©e, peau contre peau.',
      'Tu explores avidement sa bouche, il/elle se cambre vers toi.',
      'Un baiser interdit, br√ªlant, vos regards s\‚Äôembrasent ensuite.',
      'Baiser si intense qu‚Äôil/elle g√©mit ton pr√©nom.'
    ],
    fail: [
      '{cible} d√©tourne la t√™te, sourire g√™n√© mais clair.',
      'Tes l√®vres s‚Äôapprochent‚Ä¶ rejet poli.',
      'Il/elle bloque d‚Äôun doigt sur ta bouche.',
      'Timing rat√©, {cible} recule.',
      'Ton geste est trop brusque, il/elle fronce les sourcils.',
      'Tentative maladroite, il/elle √©clate de rire.',
      '{cible} esquive, laissant tes l√®vres embrasser le vide.',
      'Tu sens sa g√™ne, il/elle change de sujet aussit√¥t.',
      'Tes l√®vres fr√¥lent sa joue, refus implicite.',
      'Il/elle se recule s√®chement, ambiance refroidie.'
    ]
  },
  flirt: {
    success: [
      'Ton clin d‚Äô≈ìil fait mouche, {cible} rougit.',
      'Une phrase subtile‚Ä¶ il/elle rit et se rapproche.',
      'Ton charme op√®re, {cible} joue avec ses cheveux.',
      'Un sourire malicieux, {cible} mordille sa l√®vre.',
      'Tes yeux parlent plus que tes mots, et {cible} comprend.',
      'Ton compliment os√© arrache un soupir √† {cible}.',
      'Ta voix grave le/la fait frissonner.',
      'Ton humour d√©sarme {cible}, rire nerveux, mais s√©duit.',
      'Ton aura magn√©tique le/la captive.',
      'Un mot doux gliss√©‚Ä¶ {cible} te fixe intens√©ment.'
    ],
    fail: [
      'Tu lances une phrase‚Ä¶ silence g√™nant.',
      '{cible} d√©tourne les yeux, pas r√©ceptif/ve.',
      'Ton humour tombe √† plat, malaise.',
      'Clin d‚Äô≈ìil rat√©, √ßa fait forc√©.',
      'Compliment mal choisi, {cible} soupire d‚Äôagacement.',
      'Ton approche est trop lourde, il/elle l√®ve les yeux au ciel.',
      'Tu bafouilles, moment cass√©.',
      'Ton charme ne prend pas cette fois.',
      '{cible} rit‚Ä¶ mais de toi, pas avec toi.',
      'Tu vises trop haut, rejet sec.'
    ]
  },
  seduce: {
    success: [
      'Ta voix suave envo√ªte {cible}, s√©duction r√©ussie.',
      'Tes gestes lents font monter la temp√©rature.',
      'Ton regard magn√©tique le/la cloue sur place.',
      'Chaque mot est une caresse, il/elle succombe.',
      'Tu effleures sa main‚Ä¶ frisson imm√©diat.',
      'Ton sourire charmeur le/la fait fondre.',
      'Tu avances subtilement, {cible} recule‚Ä¶ mais vers toi.',
      'S√©duction animale, {cible} ne r√©siste pas.',
      'Ton parfum, ta pr√©sence‚Ä¶ tout l‚Äôattire.',
      'Un murmure √† son oreille, et {cible} s‚Äôabandonne.'
    ],
    fail: [
      'Tu forces trop, il/elle recule net.',
      'Tes mots sonnent faux, le charme casse.',
      '{cible} esquisse un sourire froid.',
      'Ton geste s√©ducteur tombe √† plat.',
      'Tu veux trop plaire, √ßa se sent.',
      'Il/elle hausse un sourcil, pas convaincu(e).',
      'Ton aura n‚Äôaccroche pas, tu te heurtes √† un mur.',
      'S√©duction rat√©e, il/elle change de sujet.',
      'Trop direct, {cible} recule.',
      'Moment glac√©, magie bris√©e.'
    ]
  }
};
// Fonction handleEconomyAction - utilis√©e par toutes les commandes d'√©conomie et d'actions

// Persistance Truth/Dare
async function saveTDState() {
  if (!client._tdQueue) return;
  const fs = require('fs');
  const state = { queues: {}, counters: {} };
  for (const [key, queue] of client._tdQueue.entries()) {
    if (Array.isArray(queue) && queue.length > 0) state.queues[key] = queue;
  }
  if (client._tdCounter) {
    for (const [key, count] of client._tdCounter.entries()) state.counters[key] = count;
  }
  setImmediate(() => {
    try {
      fs.writeFileSync('./data/td-queues.json', JSON.stringify(state, null, 2), 'utf8');
    } catch (err) {
      console.error('[TD Save] Erreur:', err.message);
    }
  });
}

function loadTDState() {
  const fs = require('fs');
  try {
    if (fs.existsSync('./data/td-queues.json')) {
      const data = fs.readFileSync('./data/td-queues.json', 'utf8');
      const state = JSON.parse(data);
      if (!client._tdQueue) client._tdQueue = new Map();
      const queues = state.queues || state;
      for (const [key, queue] of Object.entries(queues)) {
        if (Array.isArray(queue)) client._tdQueue.set(key, queue);
      }
      if (!client._tdCounter) client._tdCounter = new Map();
      if (state.counters) {
        for (const [key, count] of Object.entries(state.counters)) {
          client._tdCounter.set(key, count);
        }
      }
      console.log('[TD] ‚úÖ √âtat charg√©:', Object.keys(queues).length, 'queues,', Object.keys(state.counters || {}).length, 'compteurs');
    }
  } catch (err) {
    console.error('[TD Load] Erreur:', err.message);
  }
}

async function handleEconomyAction(interaction, actionKey) {
  // DM fast-path: reply with embed + ping, avoid guild access
  try {
  // R√©cup√©rer la config √©conomie
  const eco = interaction.guild ? await getEconomyConfig(interaction.guild.id) : { actions: { enabled: [] } };
  // V√©rifier que l'utilisateur n'est pas un bot
  if (interaction.user?.bot) {
    return respondAndUntrack({ content: '‚õî Les bots ne peuvent pas utiliser cette action.', ephemeral: true });
  }
  
  // DM fast-path: reply simple sans √©conomie avec GIF
  try {
    if (!interaction.guild) {
      const { EmbedBuilder, AttachmentBuilder } = require('discord.js');
      
      // Defer pour √©viter le timeout
      let hasDeferred = false;
      try {
        if (!interaction.deferred && !interaction.replied) {
          await interaction.deferReply();
          hasDeferred = true;
        }
      } catch (_) {}
      
      const targetUser = interaction.options?.getUser?.('cible', false) || null;
      const authorId = interaction.user?.id || null;
      const targetId = targetUser?.id || null;
      const who = authorId ? `<@${authorId}>` : (interaction.user?.username || 'toi');
      const targetMention = targetId ? `<@${targetId}>` : '';
      
      // Charger la config depuis GUILD_ID pour avoir les GIFs et labels
      const guildIdForConfig = process.env.GUILD_ID || process.env.FORCE_GUILD_ID || '';
      let actionLabel = actionKey;
      let actionPhrase = 'Action r√©alis√©e !';
      let gifUrl = null;
      
      if (guildIdForConfig) {
        try {
          const ecoConfig = await getEconomyConfig(guildIdForConfig);
          
          // Label
          const actionsList = ecoConfig?.actions?.list || {};
          const actionConf = actionsList[actionKey];
          if (actionConf?.label) {
            actionLabel = actionConf.label;
          }
          
          // GIFs (on prend toujours success en MP, pas de fail)
          const gifs = ((ecoConfig.actions?.gifs || {})[actionKey]) || { success: [], fail: [] };
          const gifList = Array.isArray(gifs.success) && gifs.success.length ? gifs.success : [];
          if (gifList.length > 0) {
            gifUrl = gifList[Math.floor(Math.random() * gifList.length)];
          }
          
          // Phrases avec support des zones
          const cfgMsg = ((ecoConfig.actions?.messages || {})[actionKey]) || { success: [], fail: [] };
          
          // R√©cup√©rer la zone s√©lectionn√©e si pr√©sente
          const selectedZone = interaction.options?.getString?.('zone', false) || null;
          let texts = [];
          
          if (selectedZone && cfgMsg.zones) {
            // Chercher la zone (case-insensitive)
            const zoneKeys = Object.keys(cfgMsg.zones);
            const matchedZoneKey = zoneKeys.find(k => k.toLowerCase() === selectedZone.toLowerCase());
            
            if (matchedZoneKey && Array.isArray(cfgMsg.zones[matchedZoneKey]?.success) && cfgMsg.zones[matchedZoneKey].success.length) {
              texts = cfgMsg.zones[matchedZoneKey].success;
              console.log(`[DM] Zone "${selectedZone}" trouv√©e: ${texts.length} phrases`);
            } else {
              console.log(`[DM] Zone "${selectedZone}" sans phrases sp√©cifiques, fallback aux messages g√©n√©raux`);
              texts = Array.isArray(cfgMsg.success) ? cfgMsg.success : [];
            }
          } else {
            // Pas de zone s√©lectionn√©e, utiliser les messages g√©n√©raux
            texts = Array.isArray(cfgMsg.success) ? cfgMsg.success : [];
          }
          
          if (texts.length > 0) {
            actionPhrase = texts[Math.floor(Math.random() * texts.length)];
            // Remplacer les placeholders
            actionPhrase = actionPhrase
              .replace(/\{target\}/gi, targetMention)
              .replace(/\{cible\}/gi, targetMention)
              .replace(/\{zone\}/gi, selectedZone || '');
          }
        } catch (e) {
          console.error('[DM] Error loading config:', e.message);
        }
      }
      
      // Cr√©er l'embed de base
      const embed = new EmbedBuilder()
        .setColor(0xE91E63)
        .setTitle(`üíù ${actionLabel}`)
        .setDescription(`${actionPhrase}

${who}${targetMention ? ' ‚Üí ' + targetMention : ''}`)
        .setFooter({ text: 'En MP ‚Ä¢ Pas d\'√©conomie ni de cooldown' });
      
      // Charger et attacher le GIF si disponible
      let imageAttachment = null;
      let resolvedGifUrl = gifUrl;
      
      if (gifUrl) {
        try {
          // R√©soudre l'URL du GIF (Tenor, etc.)
          const resolved = await resolveGifUrl(gifUrl, { timeoutMs: 2000 });
          if (resolved) {
            resolvedGifUrl = resolved;
          }
          
          // V√©rifier si c'est une URL directe d'image
          const isDirect = isLikelyDirectImageUrl(resolvedGifUrl);
          
          if (isDirect) {
            // Utiliser setImage pour les URLs directes
            embed.setImage(resolvedGifUrl);
          } else {
            // Essayer de t√©l√©charger et attacher l'image
            const att = await tryCreateImageAttachmentFromUrl(resolvedGifUrl, { timeoutMs: 3000 });
            if (att && att.attachment) {
              imageAttachment = att;
              embed.setImage(`attachment://${att.filename}`);
            } else {
              // Fallback: mettre l'URL m√™me si non directe
              embed.setImage(resolvedGifUrl);
            }
          }
        } catch (error) {
          console.warn(`[DM] Failed to load GIF ${gifUrl}:`, error.message);
          // Continue sans GIF
        }
      }
      
      // Pr√©parer la payload
      const allowed = { users: [authorId, targetId].filter(Boolean), repliedUser: false };
      const payload = { 
        embeds: [embed], 
        allowedMentions: allowed
      };
      
      // Ajouter l'attachment si disponible
      if (imageAttachment) {
        payload.files = [imageAttachment.attachment];
      }
      
      // Envoyer la r√©ponse (toujours, m√™me en cas d'erreur)
      try {
        if (interaction.deferred || interaction.replied) {
          await interaction.editReply(payload);
        } else {
          await interaction.reply(payload);
        }
      } catch (replyError) {
        console.error('[DM] Failed to send reply:', replyError.message);
        // Derni√®re tentative avec juste du texte
        try {
          const fallbackPayload = { content: `${actionLabel}: ${actionPhrase}`, allowedMentions: allowed };
          if (interaction.deferred || interaction.replied) {
            await interaction.editReply(fallbackPayload);
          } else {
            await interaction.reply(fallbackPayload);
          }
        } catch (_) {}
      }
      
      // Untrack
      try { untrackInteraction?.(interaction); } catch(_) {}
      return;
    }
  } catch (dmError) {
    console.error('[DM] Critical error:', dmError);
    // S'assurer qu'on r√©pond toujours
    try {
      const errorMsg = '‚ùå Erreur lors de l\'ex√©cution en MP.';
      if (interaction.deferred || interaction.replied) {
        await interaction.editReply({ content: errorMsg });
      } else {
        await interaction.reply({ content: errorMsg, ephemeral: true });
      }
    } catch (_) {}
    return;
  }
      if (!interaction.guildId) {
        try { if (!interaction.deferred && !interaction.replied) await interaction.deferReply(); } catch (_) {}
        const gid = process.env.GUILD_ID || process.env.FORCE_GUILD_ID || '';
        let eco = {};
        try { eco = gid ? (await getEconomyConfig(gid)) : {}; } catch (_) { eco = {}; }
        const msgAll = (eco && eco.actions && eco.actions.messages) ? eco.actions.messages : {};
        const confAll = (eco && eco.actions && eco.actions.config) ? eco.actions.config : {};
        const conf = confAll[actionKey] || {};
        const successRate = Math.max(0, Math.min(1, Number(conf.successRate ?? 0.8)));
        const isSuccess = Math.random() < successRate;
        const msgs = (msgAll[actionKey] || { success: [], fail: [] });
        const chosenTexts = isSuccess ? (Array.isArray(msgs.success) ? msgs.success : []) : (Array.isArray(msgs.fail) ? msgs.fail : []);
        const targetUser = interaction.options?.getUser?.('cible', false)
          || interaction.options?.getUser?.('membre', false)
          || interaction.options?.getUser?.('member', false)
          || interaction.options?.getUser?.('target', false)
          || null;
        const authorId = interaction.user?.id || null;
        const targetId = targetUser?.id || null;
        const who = authorId ? `<@${authorId}>` : (interaction.user?.username || 'toi');
        const targetMention = targetId ? `<@${targetId}>` : '';
        const header = `‚úÖ Action '${actionKey}' en MP ‚Äî ${who}${targetMention ? ' ‚Üí ' + targetMention : ''}`;
        let text = (Array.isArray(chosenTexts) && chosenTexts.length) ? String(chosenTexts[Math.floor(Math.random()*chosenTexts.length)]||'').trim() : '' ;
        if (!text) text = isSuccess ? `Action ${actionKey} r√©ussie.` : `Action ${actionKey} √©chou√©e.`;
        try {
          const zOpt = String((interaction.options?.getString?.('zone', false)||'')||'').toLowerCase();
          let allowed = ['corps'];
          if (actionKey === 'doigter') allowed = ['chatte','cul'];
          else if (actionKey === 'branler') allowed = ['bite'];
          else if (actionKey === 'orgasme') allowed = ['chatte','bite','corps'];
          const zoneVal = allowed.includes(zOpt) ? zOpt : allowed[Math.floor(Math.random()*allowed.length)];
          text = String(text||'').replaceAll('{target}', targetMention).replaceAll('{cible}', targetMention).replaceAll('{zone}', zoneVal);
} catch (_) {}
        let EmbedBuilder = null; try { ({ EmbedBuilder } = require('discord.js')); } catch (_) {}
        let embed = null; if (EmbedBuilder) { embed = new EmbedBuilder().setColor(isSuccess ? 0xE91E63 : 0x9E9E9E).setTitle('üî• ACTION').setDescription(text); }
        const allowed = { users: [authorId, targetId].filter(Boolean), repliedUser: false };
        const payload = embed ? { content: header, embeds: [embed], allowedMentions: allowed } : { content: header + (text ? ('\n' + text) : ''), allowedMentions: allowed };
        if (interaction.deferred || interaction.replied) await interaction.editReply(payload); else await interaction.reply(payload);
        try { untrackInteraction?.(interaction); } catch(_) {}
        return;
      }
    } catch (_) {}


  // RENDER OPTIMIZATION: D√©f√©rer IMM√âDIATEMENT avant tout traitement
  const wasDeferred = await immediatelyDeferInteraction(interaction, `economy-${actionKey}`);
  if (!wasDeferred && !interaction.replied) {
    try {
      await interaction.reply({ content: '‚è≥ Traitement en cours...', ephemeral: true });
    } catch (_) {}
  }
  let fallbackTimer = null;
  const clearFallbackTimer = () => { 
    try { 
      if (fallbackTimer) { 
        clearTimeout(fallbackTimer); 
        fallbackTimer = null; 
        console.log(`[Economy] Cleared fallback timer for ${actionKey} - clearFallbackTimer setTimeout fallbackTimer tous timers`);
      } 
    } catch (_) {} 
  };
  const respondAndUntrack = async (payload, preferFollowUp = false) => {
    try {
      console.log('[RESPOND DEBUG] Payload re√ßu:', JSON.stringify(payload, null, 2));
      clearFallbackTimer();
      if (interaction.deferred || interaction.replied) {
        const cloned = { ...(payload || {}) };
        try { if ('ephemeral' in cloned) delete cloned.ephemeral; } catch (_) {}
        if (preferFollowUp) {
          return await interaction.followUp(cloned);
        }
        return await interaction.editReply(cloned);
      }
      return await interaction.reply(payload);
    } finally {
      try { untrackInteraction(interaction); } catch (_) {}
    }
  };
  
  try {
  // D√âSACTIV√â: Early defer (remplac√© par pre-ping avec notification)
  /*
    // Early defer for heavy actions BEFORE any storage access to avoid 3s timeout
    const heavyActions = ['work', 'fish', 'daily', 'steal', 'kiss', 'flirt', 'seduce', 'fuck', 'sodo', 'orgasme', 'lick', 'suck', 'nibble', 'branler', 'doigter', 'tromper', 'orgie', 'sixtynine'];
    let hasDeferred = false;
    if (heavyActions.includes(actionKey)) {
      try {
        if (!interaction.deferred && !interaction.replied) {
          await interaction.deferReply();
          hasDeferred = true;
          console.log(`[Economy] Early defer for heavy action: ${actionKey}`);
          try {
            clearFallbackTimer();
            fallbackTimer = setTimeout(async () => {
              try {
                if (!interaction.replied && interaction.deferred) {
                  await interaction.editReply({ content: '‚è≥ Toujours en cours‚Ä¶ merci de patienter quelques secondes de plus.' });
                }
              } catch (fallbackError) {
                console.error(`[Economy] Fallback timer error for ${actionKey}:`, fallbackError.message);
              }
            }, 4000); // R√©duit √† 4s pour √©viter les conflits
          } catch (_) {}
        }
      } catch (error) {
        console.error(`[Economy] Early defer failed for ${actionKey}:`, error.message);
        // Continue m√™me si le defer √©choue - on essaiera plus tard
      }
    }
    const eco = interaction.guild ? await getEconomyConfig(interaction.guild.id) : { actions: { enabled: [] } };
    // Disallow bot users executing actions
    if (interaction.user?.bot) {
      return respondAndUntrack({ content: '‚õî Les bots ne peuvent pas utiliser cette action.', ephemeral: true });
    }
  */
  const eco = interaction.guild ? await getEconomyConfig(interaction.guild.id) : { actions: { enabled: [] } };
  // Check enabled
  const enabled = Array.isArray(eco.actions?.enabled) ? eco.actions.enabled : [];
  if (enabled.length && !enabled.includes(actionKey)) {
    return renderSafeReply(interaction, "‚õî Action d√©sactiv√©e.", { ephemeral: true });
  }
  // Resolve optional/required partner for actions that target a user
  const actionsWithTarget = ['kiss','flirt','seduce','fuck','sodo','orgasme','branler','doigter','hairpull','caress','lick','suck','nibble','tickle','revive','comfort','massage','dance','shower','wet','bed','undress','collar','leash','kneel','order','punish','rose','wine','pillowfight','sleep','oops','caught','tromper','orgie','touche','reveiller','sixtynine','calin','give','steal'];
  let initialPartner = null;
  let tromperResolvedPartner = null;
  try {
    if (actionsWithTarget.includes(actionKey)) {
      // Only get the target if user actually provided one
      initialPartner = interaction.options.getUser('cible', false);
      // Auto-pick random partner ONLY for tromper and orgie actions
      if (!initialPartner && (actionKey === 'tromper' || actionKey === 'orgie')) {
        try {
          let pick = null;
          // Prefer channel members for relevance
          try {
            const chMembers = interaction.channel?.members?.filter?.(m => !m.user.bot && m.user.id !== interaction.user.id);
            if (chMembers && chMembers.size > 0) {
              const arr = Array.from(chMembers.values());
              pick = arr[Math.floor(Math.random() * arr.length)];
            }
          } catch (_) {}
          // Fallback to guild cache
          if (!pick) {
            const candidates = interaction.guild.members.cache.filter(m => !m.user.bot && m.user.id !== interaction.user.id);
            if (candidates.size > 0) {
              const arr = Array.from(candidates.values());
              pick = arr[Math.floor(Math.random() * arr.length)];
            }
          }
          // Final fallback: attempt a fast fetch of members (requires Member intent)
          if (!pick) {
            try {
              const fetchedAll = await interaction.guild.members.fetch().catch(()=>null);
              if (fetchedAll) {
                const filtered = fetchedAll.filter(m => !m.user.bot && m.user.id !== interaction.user.id);
                if (filtered.size > 0) {
                  const arr = Array.from(filtered.values());
                  pick = arr[Math.floor(Math.random() * arr.length)];
                }
              }
            } catch (_) {}
          }
          if (pick) initialPartner = pick.user;
        } catch (_) {}
      }
    } else if (actionKey === 'crime') {
      initialPartner = interaction.options.getUser('complice', false);
    }
  } catch (_) {}
  if (initialPartner && initialPartner.bot) {
    return renderSafeReply(interaction, "‚õî Cible invalide: les bots sont exclus.", { ephemeral: true });
  }
  
  // D√©clarer hasDeferred AVANT son utilisation
  let hasDeferred = false;
  
  // Pour les actions lourdes comme 'tromper', s'assurer qu'on a bien defer (!hasDeferred tromper orgie √©viter double defer)
  if ((actionKey === 'tromper' || actionKey === 'orgie') && !hasDeferred) {
    try {
      if (!interaction.deferred && !interaction.replied) {
        await interaction.deferReply();
        hasDeferred = true;
        console.log(`[${actionKey === 'tromper' ? 'Tromper' : 'Orgie'}] Reply deferred to prevent timeout`);
        try {
          clearFallbackTimer();
          fallbackTimer = setTimeout(async () => {
            try {
              if (!interaction.replied && interaction.deferred) {
                await interaction.editReply({ content: '‚è≥ Toujours en cours‚Ä¶ merci de patienter quelques secondes de plus.' });
              }
            } catch (fallbackError) {
              console.error(`[${actionKey === 'tromper' ? 'Tromper' : 'Orgie'}] Fallback timer error:`, fallbackError.message);
              console.error(`[${actionKey === 'tromper' ? 'Tromper' : 'Orgie'}] Stack trace:`, fallbackError?.stack);
            }
          }, 6000); // 6s pour √©viter conflits avec le timer pr√©c√©dent
        } catch (_) {}
      }
    } catch (error) {
      console.error(`[${actionKey === 'tromper' ? 'Tromper' : 'Orgie'}] Failed to defer reply:`, error.message);
      // Ne pas retourner ici - continuer avec l'action m√™me sans defer
      console.log(`[${actionKey === 'tromper' ? 'Tromper' : 'Orgie'}] Continuing without defer...`);
    }
  }
  // DEFER pour toutes les actions - les mentions seront dans le message final
  if (!hasDeferred && !interaction.replied && !interaction.deferred) {
    try {
      await interaction.deferReply();
      hasDeferred = true;
      console.log(`[Economy] Defer pour ${actionKey}${initialPartner ? ' avec target: ' + initialPartner.id : ''}`);
    } catch (err) {
      console.error(`[Economy] Erreur defer:`, err.message);
    }
  }

  // (removed duplicate heavy defer block; handled earlier)
  
  const u = await getEconomyUser(interaction.guild?.id || "dm", interaction.user.id);
  // Capture valeurs avant modifications pour le contr√¥le de franchissement
  const prevCharm = Number(u.charm || 0);
  const prevPerversion = Number(u.perversion || 0);
  const prevAmount = Number(u.amount || 0);
  const now = Date.now();
  const conf = (eco.actions?.config || {})[actionKey] || {};
  const baseCd = Number(eco.settings?.cooldowns?.[actionKey] || conf.cooldown || 0);
  let cdLeft = Math.max(0, (u.cooldowns?.[actionKey] || 0) - now);
  if (cdLeft > 0) {
    const txt = `Veuillez patienter ${Math.ceil(cdLeft/1000)}s avant de r√©essayer.`;
    if (interaction.deferred || hasDeferred) {
      return respondAndUntrack({ content: txt });
    }
    return respondAndUntrack({ content: txt, ephemeral: true });
  }
  // Booster cooldown multiplier
  let cdToSet = baseCd;
  try {
    const b = eco.booster || {};
    const mem = await interaction.guild.members.fetch(interaction.user.id).catch(()=>null);
    const isBooster = Boolean(mem?.premiumSince || mem?.premiumSinceTimestamp);
    if (b.enabled && isBooster && Number(b.actionCooldownMult) > 0) {
      cdToSet = Math.round(cdToSet * Number(b.actionCooldownMult));
    }
  } catch (_) {}
  // Utility
  const setCd = (k, sec) => { if (!u.cooldowns) u.cooldowns = {}; u.cooldowns[k] = now + sec*1000; };
  const randInt = (min, max) => Math.floor(min + Math.random() * (max - min + 1));
  const gifs = ((eco.actions?.gifs || {})[actionKey]) || { success: [], fail: [] };
  const cfgMsg = ((eco.actions?.messages || {})[actionKey]) || { success: [], fail: [] };
  
  // Support des zones personnalis√©es
  let selectedZone = null;
  const actionConfig = (eco.actions?.config || {})[actionKey] || {};
  
  // R√©cup√©rer la zone depuis les options de la commande
  try {
    const userZone = interaction.options?.getString?.('zone', false);
    if (userZone) {
      selectedZone = userZone;
      console.log(`[${actionKey}] Zone choisie par l'utilisateur: ${selectedZone}`);
    }
  } catch (_) {}
  
  // Si pas de zone choisie, en s√©lectionner une al√©atoirement
  if (!selectedZone && actionConfig.zones && Array.isArray(actionConfig.zones) && actionConfig.zones.length > 0) {
    selectedZone = actionConfig.zones[Math.floor(Math.random() * actionConfig.zones.length)];
    console.log(`[${actionKey}] Zone s√©lectionn√©e al√©atoirement: ${selectedZone}`);
  }
  
  // R√©cup√©rer les messages (avec zones si disponibles)
  let successMessages = cfgMsg.success || [];
  let failMessages = cfgMsg.fail || [];
  
  // Chercher la zone avec comparaison insensible √† la casse
  let matchedZoneKey = null;
  if (selectedZone && cfgMsg.zones) {
    // Chercher d'abord une correspondance exacte
    if (cfgMsg.zones[selectedZone]) {
      matchedZoneKey = selectedZone;
    } else {
      // Sinon chercher avec casse insensible
      const zoneLower = selectedZone.toLowerCase();
      for (const zoneKey of Object.keys(cfgMsg.zones)) {
        if (zoneKey.toLowerCase() === zoneLower) {
          matchedZoneKey = zoneKey;
          break;
        }
      }
    }
  }
  
  console.log(`[${actionKey}] selectedZone:`, selectedZone);
  console.log(`[${actionKey}] matchedZoneKey:`, matchedZoneKey);
  
  if (matchedZoneKey && cfgMsg.zones[matchedZoneKey]) {
    // Utiliser les messages de la zone s√©lectionn√©e
    if (Array.isArray(cfgMsg.zones[matchedZoneKey].success) && cfgMsg.zones[matchedZoneKey].success.length > 0) {
      successMessages = cfgMsg.zones[matchedZoneKey].success;
      console.log(`[${actionKey}] ‚úÖ Utilisation messages zone "${matchedZoneKey}": ${successMessages.length} succ√®s`);
    }
    if (Array.isArray(cfgMsg.zones[matchedZoneKey].fail) && cfgMsg.zones[matchedZoneKey].fail.length > 0) {
      failMessages = cfgMsg.zones[matchedZoneKey].fail;
    }
  } else if (selectedZone) {
    console.log(`[${actionKey}] ‚ö†Ô∏è  Zone "${selectedZone}" s√©lectionn√©e mais pas trouv√©e (keys: ${cfgMsg.zones ? Object.keys(cfgMsg.zones).join(", ") : "aucune"})`);
  }
  
  // Merge with erotic bank if present
  const erotic = eroticMsgBank[actionKey] || { success: [], fail: [] };
  const msgSet = {
    success: Array.isArray(successMessages) && successMessages.length ? successMessages : erotic.success,
    fail: Array.isArray(failMessages) && failMessages.length ? failMessages : erotic.fail
  };
  console.log(`[${actionKey}] successMessages:`, successMessages);
  console.log(`[${actionKey}] msgSet.success:`, msgSet.success);
  let msgText = null;
  const successRate = Number(conf.successRate ?? 1);
  const success = Math.random() < successRate;
  // Grants ne sont pas ajout√©s √† chaque action: ils seront attribu√©s une seule fois via un embed s√©par√© quand le seuil est atteint
  let grantMoney = 0; // legacy var (non utilis√© dans le calcul de l'embed principal)
  // XP config
  const xpOnSuccess = Math.max(0, Number(conf.xpDelta || 0));
  const xpOnFail = Math.max(0, Number(conf.failXpDelta || 0));
  const partnerXpShare = Math.max(0, Number(conf.partnerXpShare || 0));
  const awardXp = async (userId, baseXp) => {
    try {
      // Skip XP for bots if ever called with a bot ID
      try { const m = await interaction.guild.members.fetch(userId).catch(()=>null); if (m?.user?.bot) return; } catch (_) {}
      const levels = await getLevelsConfig(interaction.guild.id);
      if (!levels?.enabled) return;
      const add = Math.max(0, Math.round(baseXp));
      if (add <= 0) return;
      const stats = await getUserStats(interaction.guild.id, userId);
      const prevLevel = stats.level || 0;
      stats.xp = (stats.xp||0) + add;
      const norm = xpToLevel(stats.xp, levels.levelCurve || { base: 100, factor: 1.2 });
      stats.level = norm.level;
      stats.xpSinceLevel = norm.xpSinceLevel;
      await setUserStats(interaction.guild.id, userId, stats);
      if (stats.level > prevLevel) {
        const mem = await fetchMember(interaction.guild, userId);
        if (mem) {
          maybeAnnounceLevelUp(interaction.guild, mem, levels, stats.level);
          const rid = (levels.rewards || {})[String(stats.level)];
          if (rid) {
            try { await mem.roles.add(rid); } catch (_) {}
            maybeAnnounceRoleAward(interaction.guild, mem, levels, rid);
          }
        }
      }
    } catch (_) {}
  };
  let moneyDelta = 0;
  let karmaField = null;
  let karmaBonus = 0;
  let karmaBonusPercent = 0;
  let imageUrl = undefined;
  if (success) {
    moneyDelta = randInt(Number(conf.moneyMin||0), Number(conf.moneyMax||0));
    // Calculate karma action bonus
    const actionModifiers = eco.karmaModifiers?.actions || [];
    karmaBonusPercent = calculateKarmaActionModifier(actionModifiers, u.charm || 0, u.perversion || 0);
    if (karmaBonusPercent > 0 && moneyDelta > 0) {
      karmaBonus = Math.floor(moneyDelta * karmaBonusPercent / 100);
      moneyDelta += karmaBonus;
      console.log(`[KARMA BONUS] Action: ${actionKey}, Base: ${moneyDelta - karmaBonus}, Bonus: +${karmaBonusPercent}% (+${karmaBonus}), Total: ${moneyDelta}`);
    }
    if (conf.karma === 'charm') { u.charm = (u.charm||0) + Number(conf.karmaDelta||0); karmaField = ['Karma charme', `+${Number(conf.karmaDelta||0)}`]; }
    else if (conf.karma === 'perversion') { u.perversion = (u.perversion||0) + Number(conf.karmaDelta||0); karmaField = ['Karma perversion', `+${Number(conf.karmaDelta||0)}`]; }
    imageUrl = Array.isArray(gifs.success) && gifs.success.length ? gifs.success[Math.floor(Math.random()*gifs.success.length)] : undefined;
  } else {
    moneyDelta = randInt(Number(conf.failMoneyMin||0), Number(conf.failMoneyMax||0));
    const karmaDelta = Number(conf.failKarmaDelta||0);
    if (conf.karma === 'charm') { 
      u.charm = (u.charm||0) + karmaDelta; 
      karmaField = ['Karma charme', `${karmaDelta >= 0 ? '+' : ''}${karmaDelta}`]; 
    }
    else if (conf.karma === 'perversion') { 
      u.perversion = (u.perversion||0) + karmaDelta; 
      karmaField = ['Karma perversion', `${karmaDelta >= 0 ? '+' : ''}${karmaDelta}`]; 
    }
    imageUrl = Array.isArray(gifs.fail) && gifs.fail.length ? gifs.fail[Math.floor(Math.random()*gifs.fail.length)] : undefined;
  }
  if (imageUrl) {
    try {
      console.log(`[IMAGE DEBUG] imageUrl brut: ${imageUrl}`);
      imageUrl = await resolveGifUrl(String(imageUrl), { timeoutMs: 2500 });
      console.log(`[IMAGE DEBUG] imageUrl r√©solu: ${imageUrl}`);
      console.log(`[IMAGE DEBUG] isLikelyDirectImageUrl:`, isLikelyDirectImageUrl(imageUrl));
    } catch (e) {
      console.error(`[IMAGE DEBUG] Erreur normalizeGifUrlBasic:`, e.message);
    }
  } else {
    console.log(`[IMAGE DEBUG] Pas d'imageUrl configur√© pour action ${actionKey}, success=${success}`);
    console.log(`[IMAGE DEBUG] gifs.success:`, gifs.success?.length || 0, 'URLs');
    console.log(`[IMAGE DEBUG] gifs.fail:`, gifs.fail?.length || 0, 'URLs');
  }
  // Special storyline for tromper (NSFW) and orgie (NSFW group)
  if (actionKey === 'tromper') {
    console.log('[Tromper] Starting tromper action for user:', interaction.user.id);
    let partner = initialPartner;
    let third = null;
    
    
    try {
      console.log('[Tromper] Getting available members from cache...');
      
      // Fetch tous les membres (rapide avec 63 membres)
      console.log('[Tromper] Fetching guild members...');
      let availableMembers = new Map();
      
      try {
        const fetched = await interaction.guild.members.fetch({ force: false });
        const fetchedHumans = fetched.filter(m => !m.user.bot && m.user.id !== interaction.user.id);
        console.log('[Tromper] Fetched members:', fetchedHumans.size);
        availableMembers = fetchedHumans;
      } catch (fetchError) {
        console.error('[Tromper] Fetch failed:', fetchError.message);
        // Fallback sur le cache
        availableMembers = interaction.guild.members.cache.filter(m => !m.user.bot && m.user.id !== interaction.user.id);
        console.log('[Tromper] Using cache:', availableMembers.size);
      }
      
      // Fallback d'urgence: si aucun membre disponible, utiliser une r√©ponse simplifi√©e
      if (availableMembers.size === 0) {
        console.warn('[Tromper] No members available, using simplified response');
        const fallbackMsg = success ? 
          'Tu r√©ussis ton plan... mais discr√®tement ! ü§´' : 
          'Ton plan √©choue... heureusement personne ne t\'a vu ! üòÖ';
        
        // S'assurer qu'on r√©pond toujours - RENDER OPTIMIZED
        try {
          if (isRenderEnvironment) {
            return await renderSafeReply(interaction, fallbackMsg);
          }
          return respondAndUntrack({ content: fallbackMsg });
        } catch (responseError) {
          console.error('[Tromper] Failed to send fallback response:', responseError.message);
          // Derni√®re tentative avec renderSafeReply pour Render
          if (isRenderEnvironment) {
            return await renderSafeReply(interaction, fallbackMsg);
          }
          if (!interaction.replied) {
            return await interaction.reply({ content: fallbackMsg, ephemeral: true });
          }
        }
      }
      
      // If no partner provided, auto-select a random eligible partner from available members
      if (!partner) {
        const candidates = availableMembers;
        if (candidates.size > 0) {
          // Valider que le membre s√©lectionn√© existe vraiment
          let attempts = 0;
          let validPartner = null;
          const arr = Array.from(candidates.values());
          
          while (!validPartner && attempts < 3 && arr.length > 0) {
            const randomIndex = Math.floor(Math.random() * arr.length);
            const candidate = arr[randomIndex];
            const memberCheck = await validateAndFetchMember(interaction.guild, candidate.user.id);
            
            if (memberCheck) {
              validPartner = memberCheck.user;
              console.log('[Tromper] Auto-selected valid partner:', validPartner.id);
            } else {
              // Retirer ce candidat invalide
              arr.splice(randomIndex, 1);
              attempts++;
            }
          }
          
          partner = validPartner;
          if (!partner) {
            console.log('[Tromper] No valid partner found after validation');
          }
        } else {
          console.log('[Tromper] No partner candidates available for auto-selection');
        }
      } else {
        // Valider le partenaire fourni
        const memberCheck = await validateAndFetchMember(interaction.guild, partner.id);
        if (memberCheck) {
          console.log('[Tromper] Using provided partner (validated):', partner.id);
        } else {
          console.log('[Tromper] Provided partner not valid, clearing');
          partner = null;
        }
      }
      
      // Pick third, excluding actor and partner if present
      // CORRECTION: Convertir Map en Array avant de filtrer
      const availableMembersArray = Array.from(availableMembers.values());
      const thirdCandidates = availableMembersArray.filter(m => partner ? (m.user.id !== partner.id) : true);
      console.log('[Tromper] Third member candidates:', thirdCandidates.length);
      if (thirdCandidates.length > 0) {
        // Valider le troisi√®me membre
        let attempts = 0;
        let validThird = null;
        
        while (!validThird && attempts < 3 && thirdCandidates.length > 0) {
          const randomIndex = Math.floor(Math.random() * thirdCandidates.length);
          const candidate = thirdCandidates[randomIndex];
          const memberCheck = await validateAndFetchMember(interaction.guild, candidate.user.id);
          
          if (memberCheck) {
            validThird = memberCheck.user;
            console.log('[Tromper] Selected valid third member:', validThird.id);
          } else {
            thirdCandidates.splice(randomIndex, 1);
            attempts++;
          }
        }
        
        third = validThird;
        if (!third) {
          console.log('[Tromper] No valid third member found');
        }
      } else {
        console.log('[Tromper] No third member available, will use simplified scenario');
      }
    } catch (e) {
      console.error('[Tromper] Error in member selection logic:', e?.message || e);
      console.error('[Tromper] Stack trace:', e?.stack);
      
      // Emergency fallback for tromper - fallback d'urgence en cas d'erreur critique
      try {
        const emergencyMsg = success ? 
          'Action r√©ussie malgr√© quelques complications ! üòè' : 
          'Action √©chou√©e... peut-√™tre mieux ainsi ! üòÖ';
        
        console.log('[Tromper] Using emergency fallback due to critical error');
        if (isRenderEnvironment) {
          return await renderSafeReply(interaction, emergencyMsg);
        }
        return respondAndUntrack({ content: emergencyMsg });
      } catch (emergencyError) {
        console.error('[Tromper] Emergency fallback also failed:', emergencyError.message);
        // Absolue derni√®re tentative avec Render optimization
        if (isRenderEnvironment) {
          return await renderSafeReply(interaction, '‚ö†Ô∏è Action termin√©e avec des erreurs.');
        }
        if (!interaction.replied) {
          try {
            return await interaction.reply({ content: '‚ö†Ô∏è Action termin√©e avec des erreurs.', ephemeral: true });
          } catch (_) {
            console.error('[Tromper] All response methods failed - interaction may be stuck');
          }
        }
      }
    }
    // Persist chosen partner for later use (mention + rewards/xp)
    if (partner) { 
      initialPartner = partner; 
      tromperResolvedPartner = partner; 
      console.log('[Tromper] Partner persisted for rewards');
    }
    if (!third) {
      if (success) {
        const texts = partner ? [
          `Tu prends ${partner} au pi√®ge: tout te profite‚Ä¶`,
          `Situation ambigu√´ avec ${partner}, mais tu en ressors gagnant(e).`,
        ] : [
          'Tu prends la main: tout te profite‚Ä¶',
          'Situation ambigu√´, mais tu en ressors gagnant(e).',
        ];
        msgText = texts[randInt(0, texts.length - 1)];
      } else {
        const texts = partner ? [
          `Le plan √©choue: ${partner} te surprend et te fait payer la note.`,
          `Pris(e) en faute par ${partner}, tout s\'effondre pour toi.`,
        ] : [
          'Le plan √©choue: tu es pris(e) et tu payes la note.',
          'Pris(e) en faute, tout s\'effondre pour toi.',
        ];
        msgText = texts[randInt(0, texts.length - 1)];
      }
    } else {
      console.log('[Tromper] Third member present (no penalties applied):', third.id);
      // Le troisi√®me membre est pr√©sent mais ne re√ßoit ni r√©compense ni sanction
      // Messages
      if (success) {
        const texts = [
          `Tu d√©couvres {cible} avec un(e) autre, mais tu reprends le dessus et transformes √ßa en trio br√ªlant.`,
          `{cible} te trompe avec un tiers, mais tu retournes la situation √† ton avantage.`,
          `Tu surprends {cible} en plein acte, choc initial puis domination totale de la sc√®ne.`,
          `Trahison de {cible} d√©couverte, mais tu imposes ta pr√©sence et prends le contr√¥le.`,
          `{cible} dans les bras d'un(e) autre : tu participes et renverses tout en ta faveur.`,
          `L'infid√©lit√© de {cible} devient ton terrain de jeu, tu domines la sc√®ne.`,
          `Tu les surprends ensemble, mais tu transformes la trahison en avantage torride.`,
          `{cible} te trompe, tu d√©barques et imposes un trio √† ta mani√®re.`,
          `D√©couverte choquante : {cible} avec un tiers, mais tu retournes tout en passion partag√©e.`,
          `Tu prends {cible} et l'autre sur le fait, tu sors gagnant(e) de cette trahison.`
        ];
        msgText = texts[randInt(0, texts.length - 1)];
      } else {
        const texts = [
          `Tu d√©couvres {cible} avec un(e) autre, effondrement et humiliation totale.`,
          `{cible} te trompe sous tes yeux, tu ne peux que fuir d√©vast√©(e).`,
          `Trahison r√©v√©l√©e : {cible} dans les bras d'un tiers, tout s'√©croule.`,
          `Tu surprends {cible} en plein acte, la douleur est insupportable.`,
          `{cible} te trahit avec un(e) autre, la confiance est d√©truite √† jamais.`,
          `D√©couverte d√©vastatrice : {cible} et un tiers ensemble, tu t'effondres.`,
          `L'infid√©lit√© de {cible} te brise compl√®tement, silence pesant.`,
          `Tu les trouves ensemble, {cible} te repousse froidement.`
        ];
        msgText = texts[randInt(0, texts.length - 1)];
      }
      // Attach a transient field for later embed - juste mentionner le tiers sans p√©nalit√©
      // Fetch le membre pour avoir son username
      let thirdName = null;
      
      // Essayer d'abord avec le cache
      try {
        const cachedMember = interaction.guild.members.cache.get(third.id);
        if (cachedMember) {
          thirdName = cachedMember.displayName || cachedMember.user.username || cachedMember.user.globalName;
        }
      } catch (e) {}
      
      // Si pas dans le cache, fetch
      if (!thirdName) {
        try {
          const thirdMember = await validateAndFetchMember(interaction.guild, third.id);
          thirdName = thirdMember ? (thirdMember.displayName || thirdMember.user.username || thirdMember.user.globalName) : null;
        } catch (e) {}
      }
      
      // Fallback final
      if (!thirdName) {
        thirdName = third.username || `User${third.id.slice(-4)}`;
      }
      
      console.log(`[Tromper DEBUG] Third: ID=${third.id}, username=${third.username}, fetchedName=${thirdName}`);
      const thirdFieldVal = `<@${third.id}>`;
      global.__eco_tromper_third = { name: 'Complice de la trahison', value: thirdFieldVal, inline: false };
      // Store pings for content (partner + third)
      const tromperPings = [partner, third].filter(Boolean).map(u => `<@${u.id}>`).join(' ');
      global.__eco_tromper_pings = tromperPings;
    }
    console.log('[Tromper] Tromper logic completed successfully');
  }
  // Special storyline for orgie (NSFW group): actor, optional cible, and 3-4 additional random members
  if (actionKey === 'orgie') {
    console.log('[Orgie] Starting orgie action for user:', interaction.user.id);
    let partner = initialPartner;
    let participants = [];
    try {
      // Fetch tous les membres (rapide avec 63 membres)
      console.log('[Orgie] Fetching guild members...');
      let availableMembers = new Map();
      
      try {
        const fetched = await interaction.guild.members.fetch({ force: false });
        const fetchedHumans = fetched.filter(m => !m.user.bot && m.user.id !== interaction.user.id);
        console.log('[Orgie] Fetched members:', fetchedHumans.size);
        availableMembers = fetchedHumans;
      } catch (fetchError) {
        console.error('[Orgie] Fetch failed:', fetchError.message);
        // Fallback sur le cache
        availableMembers = interaction.guild.members.cache.filter(m => !m.user.bot && m.user.id !== interaction.user.id);
        console.log('[Orgie] Using cache:', availableMembers.size);
      }
      // Ensure partner is set if provided and valid
      if (partner) {
        const memberCheck = await validateAndFetchMember(interaction.guild, partner.id);
        if (!memberCheck) {
          console.log('[Orgie] Provided partner not valid, clearing');
          partner = null;
        }
      }
      
      const excludeIds = new Set([interaction.user.id]);
      if (partner && !partner.bot) excludeIds.add(partner.id);
      // Determine number of random others: 4 if partner exists, else 5
      const needed = partner ? 4 : 5;
      const pool = Array.from(availableMembers.values())
        .filter(m => !m.user.bot && !excludeIds.has(m.user.id));
      
      // Valider et s√©lectionner les participants
      for (let i = 0; i < needed && pool.length > 0; i++) {
        let validParticipant = null;
        let attempts = 0;
        
        while (!validParticipant && attempts < 3 && pool.length > 0) {
          const idx = Math.floor(Math.random() * pool.length);
          const candidate = pool[idx];
          
          // Valider que le membre existe vraiment
          const memberCheck = await validateAndFetchMember(interaction.guild, candidate.user.id);
          
          if (memberCheck) {
            validParticipant = candidate;
            participants.push(validParticipant);
            excludeIds.add(validParticipant.user.id);
            pool.splice(idx, 1);
            console.log(`[Orgie] Valid participant #${i+1} selected:`, validParticipant.user.id);
          } else {
            // Retirer ce candidat invalide du pool
            pool.splice(idx, 1);
            attempts++;
          }
        }
        
        if (!validParticipant) {
          console.log(`[Orgie] Could not find valid participant #${i+1}`);
        }
      }
    } catch (e) {
      console.error('[Orgie] Error selecting participants:', e?.message || e);
      console.error('[Orgie] Stack trace:', e?.stack);
      
      // Emergency fallback for orgie - fallback d'urgence pour orgie
      try {
        const emergencyMsg = success ? 
          'Orgie r√©ussie... dans l\'intimit√© ! üî•' : 
          'Orgie avort√©e... peut-√™tre mieux ainsi ! üòÖ';
        
        console.log('[Orgie] Using emergency fallback due to error');
        if (isRenderEnvironment) {
          return await renderSafeReply(interaction, emergencyMsg);
        }
        return respondAndUntrack({ content: emergencyMsg });
      } catch (emergencyError) {
        console.error('[Orgie] Emergency fallback failed:', emergencyError.message);
        // Derni√®re tentative avec Render optimization
        if (isRenderEnvironment) {
          return await renderSafeReply(interaction, '‚ö†Ô∏è Action orgie termin√©e avec des erreurs.');
        }
        if (!interaction.replied) {
          try {
            return await interaction.reply({ content: '‚ö†Ô∏è Action orgie termin√©e avec des erreurs.', ephemeral: true });
          } catch (_) {
            console.error('[Orgie] All response methods failed - interaction may be stuck');
          }
        }
      }
    }
    // Construire la liste avec les objets Member directement (pas User)
    const everyoneMember = [
      partner ? (interaction.guild.members.cache.get(partner.id) || await interaction.guild.members.fetch(partner.id).catch(() => null)) : null,
      ...participants
    ].filter(Boolean);
    
    console.log(`[Orgie DEBUG] Everyone members size: ${everyoneMember.length}`);
    
    // Construire la liste d'affichage (uniquement mentions)
    const listParts = [];
    for (const member of everyoneMember) {
      const displayName = member.displayName || member.user.username || member.user.globalName || `User${member.user.id.slice(-4)}`;
      console.log(`[Orgie] ‚úÖ ${displayName} (${member.user.id})`);
      listParts.push(`<@${member.user.id}>`);
    }
    
    // Pour les mentions dans le content (User objects)
    const everyone = everyoneMember.map(m => m.user).filter(Boolean);
    const list = listParts.length ? listParts.join(', ') : 'personne';
    if (success) {
      const texts = [
        'Orgie torride, tout le monde crie de plaisir.',
        'Chaque corps trouve sa place, satisfaction totale.',
        'Les g√©missements collectifs emplissent la pi√®ce.',
        'Jeu de multiples mains, orgasme d√©multipli√©.',
        'Corps emm√™l√©s, chaleur insoutenable.',
        'Tout le monde succombe dans une extase commune.',
        'Une spirale de plaisir partag√©, explosion finale.',
        'Rires et g√©missements collectifs, pure jouissance.',
        'Orgie passionn√©e, aucun corps laiss√© de c√¥t√©.',
        'Explosion collective, jouissance partag√©e.'
      ];
      msgText = texts[randInt(0, texts.length - 1)];
    } else {
      const texts = [
        'L\'ambiance retombe, orgie annul√©e.',
        'Participants pas r√©ceptifs, fin pr√©matur√©e.',
        'D√©sirs mal synchronis√©s, jeu stopp√©.',
        'Conflits √©clatent, plaisir ruin√©.',
        'Personne n\'ose commencer, moment rat√©.'
      ];
      msgText = texts[randInt(0, texts.length - 1)];
    }
    if (everyone.length) {
      const currency = eco.currency?.name || 'BAG$';
      const label = `Participants (${everyone.length})`;
      const val = `${list}`;
      // CORRECTION: Limiter la valeur √† 1024 caract√®res (limite Discord)
      const safeVal = val.length > 1020 ? val.substring(0, 1017) + '...' : val;
      global.__ec                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const prevBtn = new ButtonBuilder()
    .setCustomId(`couleur_palette_page:${targetType}:${targetId}:${category}:${Math.max(0, off - limit)}`)
    .setLabel('‚ü® Pr√©c√©dent')
    .setStyle(ButtonStyle.Secondary)
    .setDisabled(off <= 0);
  const nextBtn = new ButtonBuilder()
    .setCustomId(`couleur_palette_page:${targetType}:${targetId}:${category}:${off + limit}`)
    .setLabel('Suivant ‚ü©')
    .setStyle(ButtonStyle.Primary)
    .setDisabled(off + limit >= total);
  const backBtn = new ButtonBuilder()
    .setCustomId(`couleur_back_to_category:${targetType}:${targetId}`)
    .setLabel('‚Ü©Ô∏è Retour')
    .setStyle(ButtonStyle.Secondary);

  const categoryNames = { pastel: 'Pastel', vif: 'Vives', sombre: 'Sombres' };
  const fields = colors.map(color => ({ name: `${color.emoji} ${color.name}`, value: `#${color.hex}`, inline: true }));
  const embed = new EmbedBuilder()
    .setColor(THEME_COLOR_PRIMARY)
    .setTitle(`üé® Attribution de couleur ‚Äî ${categoryNames[category]}`)
    .setDescription(`S√©lectionnez une couleur (${pageIndex}/${pageCount}). Utilisez les boutons pour naviguer.`)
    .setThumbnail(currentThumbnailImage)
    .setFooter({ text: 'BAG ‚Ä¢ Couleurs', iconURL: currentFooterIcon })
    .setTimestamp()
    .addFields(fields);

  const { attachment, filename } = buildPalettePreviewAttachment(colors, category, off);
  embed.setImage(`attachment://${filename}`);

  const rows = [
    new ActionRowBuilder().addComponents(colorSelect),
    new ActionRowBuilder().addComponents(backBtn, prevBtn, nextBtn),
  ];

  return { embed, rows, files: [attachment] };
}

function emojiForHex(hex) {
  try {
    const h = hex.startsWith('#') ? hex.slice(1) : hex;
    const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16);
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    const d = max - min;
    let hue = 0;
    if (d === 0) hue = 0;
    else if (max === r) hue = ((g - b) / d) % 6;
    else if (max === g) hue = (b - r) / d + 2;
    else hue = (r - g) / d + 4;
    hue = Math.round(hue * 60);
    if (hue < 0) hue += 360;
    // map to nearest color emoji
    if (max < 60) return '‚ö´Ô∏è';
    if (hue < 15 || hue >= 345) return 'üî¥';
    if (hue < 45) return 'üü†';
    if (hue < 75) return 'üü°';
    if (hue < 165) return 'üü¢';
    if (hue < 255) return 'üîµ';
    if (hue < 315) return 'üü£';
    return 'üü§';
  } catch (_) { return '‚¨õ'; }
}



async function buildTruthDareRows(guild, mode = 'sfw') {
  const td = await getTruthDareConfig(guild.id);
  const modeSelect = new StringSelectMenuBuilder().setCustomId('td_mode').setPlaceholder('Mode‚Ä¶').addOptions(
    { label: 'Action/V√©rit√©', value: 'sfw', default: mode === 'sfw' },
    { label: 'Action/V√©rit√© NSFW', value: 'nsfw', default: mode === 'nsfw' },
  );
  const channelAdd = new ChannelSelectMenuBuilder().setCustomId('td_channels_add:' + mode).setPlaceholder('Ajouter des salons‚Ä¶').setMinValues(1).setMaxValues(3).addChannelTypes(ChannelType.GuildText);
  const channelRemove = new StringSelectMenuBuilder().setCustomId('td_channels_remove:' + mode).setPlaceholder('Retirer des salons‚Ä¶').setMinValues(1).setMaxValues(Math.max(1, Math.min(25, (td[mode].channels||[]).length || 1)));
  const opts = (td[mode].channels||[]).map(id => ({ label: guild.channels.cache.get(id)?.name || id, value: id }));
  if (opts.length) channelRemove.addOptions(...opts); else channelRemove.addOptions({ label: 'Aucun', value: 'none' }).setDisabled(true);
  const addActionBtn = new ButtonBuilder().setCustomId('td_prompts_add_action:' + mode).setLabel('Ajouter ACTION').setStyle(ButtonStyle.Primary);
  const addTruthBtn = new ButtonBuilder().setCustomId('td_prompts_add_verite:' + mode).setLabel('Ajouter VERITE').setStyle(ButtonStyle.Success);
  const promptsDelBtn = new ButtonBuilder().setCustomId('td_prompts_delete:' + mode).setLabel('Supprimer prompt').setStyle(ButtonStyle.Danger);
  const promptsDelAllBtn = new ButtonBuilder().setCustomId('td_prompts_delete_all:' + mode).setLabel('Tout supprimer').setStyle(ButtonStyle.Danger);
  const promptsEditBtn = new ButtonBuilder().setCustomId('td_prompts_edit:' + mode).setLabel('Modifier prompt').setStyle(ButtonStyle.Secondary);
  return [
    new ActionRowBuilder().addComponents(modeSelect),
    new ActionRowBuilder().addComponents(channelAdd),
    new ActionRowBuilder().addComponents(channelRemove),
    new ActionRowBuilder().addComponents(addActionBtn, addTruthBtn, promptsDelBtn, promptsDelAllBtn, promptsEditBtn),
  ];
}

function clampOffset(total, offset, limit) {
  if (total <= 0) return 0;
  const lastPageStart = Math.floor((total - 1) / limit) * limit;
  if (!Number.isFinite(offset) || offset < 0) return 0;
  if (offset > lastPageStart) return lastPageStart;
  return Math.floor(offset / limit) * limit;
}

async function buildTdDeleteComponents(guild, mode = 'sfw', offset = 0) {
  const td = await getTruthDareConfig(guild.id);
  const list = (td?.[mode]?.prompts || []).slice();
  const limit = 25;
  const total = list.length;
  const off = clampOffset(total, Number(offset) || 0, limit);
  const view = list.slice(off, off + limit);
  const from = total === 0 ? 0 : off + 1;
  const to = Math.min(total, off + view.length);
  const pageText = `Prompts ${from}-${to} sur ${total}`;

  const select = new StringSelectMenuBuilder()
    .setCustomId('td_prompts_delete_select:' + mode + ':' + off)
    .setPlaceholder(total ? ('Choisir des prompts √† supprimer ‚Ä¢ ' + pageText) : 'Aucun prompt')
    .setMinValues(1)
    .setMaxValues(Math.max(1, view.length || 1));
  if (view.length) select.addOptions(...view.map(p => ({ label: `#${p.id} ${String(p.text||'').slice(0,80)}`, value: String(p.id) })));
  else select.addOptions({ label: 'Aucun', value: 'none' }).setDisabled(true);

  const hasPrev = off > 0;
  const hasNext = off + limit < total;
  const prevBtn = new ButtonBuilder().setCustomId(`td_prompts_delete_page:${mode}:${Math.max(0, off - limit)}`).setLabel('‚ü® Pr√©c√©dent').setStyle(ButtonStyle.Secondary).setDisabled(!hasPrev);
  const nextBtn = new ButtonBuilder().setCustomId(`td_prompts_delete_page:${mode}:${off + limit}`).setLabel('Suivant ‚ü©').setStyle(ButtonStyle.Primary).setDisabled(!hasNext);

  return {
    rows: [
      new ActionRowBuilder().addComponents(select),
      new ActionRowBuilder().addComponents(prevBtn, nextBtn),
    ],
    pageText,
    offset: off,
    limit,
    total,
  };
}
async function buildTdEditComponents(guild, mode = 'sfw', offset = 0) {
  const td = await getTruthDareConfig(guild.id);
  const list = (td?.[mode]?.prompts || []).slice();
  const limit = 25;
  const total = list.length;
  const off = clampOffset(total, Number(offset) || 0, limit);
  const view = list.slice(off, off + limit);
  const from = total === 0 ? 0 : off + 1;
  const to = Math.min(total, off + view.length);
  const pageText = `Prompts ${from}-${to} sur ${total}`;

  const select = new StringSelectMenuBuilder()
    .setCustomId('td_prompts_edit_select:' + mode + ':' + off)
    .setPlaceholder(total ? ('Choisir un prompt √† modifier ‚Ä¢ ' + pageText) : 'Aucun prompt')
    .setMinValues(1)
    .setMaxValues(1);
  if (view.length) select.addOptions(...view.map(p => ({ label: `#${p.id} ${String(p.text||'').slice(0,80)}`, value: String(p.id) })));
  else select.addOptions({ label: 'Aucun', value: 'none' }).setDisabled(true);

  const hasPrev = off > 0;
  const hasNext = off + limit < total;
  const prevBtn = new ButtonBuilder().setCustomId(`td_prompts_edit_page:${mode}:${Math.max(0, off - limit)}`).setLabel('‚ü® Pr√©c√©dent').setStyle(ButtonStyle.Secondary).setDisabled(!hasPrev);
  const nextBtn = new ButtonBuilder().setCustomId(`td_prompts_edit_page:${mode}:${off + limit}`).setLabel('Suivant ‚ü©').setStyle(ButtonStyle.Primary).setDisabled(!hasNext);

  return {
    rows: [
      new ActionRowBuilder().addComponents(select),
      new ActionRowBuilder().addComponents(prevBtn, nextBtn),
    ],
    pageText,
    offset: off,
    limit,
    total,
  };
}

// Calculate karma modifier percentage for shop prices
function calculateKarmaShopModifier(karmaModifiers, userCharm, userPerversion) {
  if (!Array.isArray(karmaModifiers)) return 0;
  
  return karmaModifiers.reduce((acc, rule) => {
    try {
      const expr = String(rule.condition || '')
        .toLowerCase()
        .replace(/charm/g, String(userCharm))
        .replace(/perversion/g, String(userPerversion));
      
      // Security check - only allow safe mathematical expressions
      if (!/^[0-9+\-*/%<>=!&|().\s]+$/.test(expr)) return acc;
      
      // eslint-disable-next-line no-eval
      const conditionMet = !!eval(expr);
      return conditionMet ? acc + Number(rule.percent || 0) : acc;
    } catch (_) {
      return acc;
    }
  }, 0);
}

// Calculate karma modifier percentage for action rewards
function calculateKarmaActionModifier(karmaModifiers, userCharm, userPerversion) {
  if (!Array.isArray(karmaModifiers)) return 0;
  
  console.log(`[KARMA ACTION DEBUG] Calculating modifiers: charm=${userCharm}, perversion=${userPerversion}, rules=${karmaModifiers.length}`);
  
  let totalPercent = 0;
  for (const rule of karmaModifiers) {
    try {
      if (!rule || typeof rule !== 'object') continue;
      const condition = String(rule.condition || '');
      if (!condition) continue;
      
      // Use the same evaluateKarmaCondition function for consistency
      const conditionMet = evaluateKarmaCondition(condition, userCharm, userPerversion, 0);
      console.log(`[KARMA ACTION DEBUG] Rule: ${rule.name} | Condition: ${condition} | Met: ${conditionMet} | Percent: ${rule.percent}`);
      if (conditionMet) {
        totalPercent += Number(rule.percent || 0);
      }
    } catch (e) {
      console.log(`[KARMA ACTION DEBUG] Error evaluating rule: ${e.message}`);
    }
  }
  console.log(`[KARMA ACTION DEBUG] Total bonus: ${totalPercent}%`);
  return totalPercent;
}

// Check and notify about newly unlocked karma bonuses (actions)
async function maybeAnnounceNewKarmaBonus(interaction, eco, userEcoAfter, actionKey, prevCharm, prevPerversion) {
  try {
    const bonuses = eco.karmaModifiers?.actions || [];
    if (!bonuses.length) return;
    
    // Initialize receivedBonuses if not exists
    if (!userEcoAfter.receivedBonuses) userEcoAfter.receivedBonuses = {};
    
    console.log(`[BONUS DEBUG] Checking for new bonuses: prevCharm=${prevCharm}, newCharm=${userEcoAfter.charm}, prevPerv=${prevPerversion}, newPerv=${userEcoAfter.perversion}`);
    
    for (let i = 0; i < bonuses.length; i++) {
      const rule = bonuses[i];
      if (!rule || typeof rule !== 'object') continue;
      if (userEcoAfter.receivedBonuses[i]) continue; // Already announced
      
      const condition = String(rule.condition || '');
      if (!condition) continue;
      
      // Check if bonus was just unlocked
      const wasOk = evaluateKarmaCondition(condition, Number(prevCharm || 0), Number(prevPerversion || 0), 0);
      const nowOk = evaluateKarmaCondition(condition, userEcoAfter.charm || 0, userEcoAfter.perversion || 0, 0);
      
      console.log(`[BONUS DEBUG] Rule ${i}: ${rule.name} | wasOk=${wasOk}, nowOk=${nowOk}`);
      
      if (!wasOk && nowOk) {
        // NEW BONUS UNLOCKED!
        const percent = Number(rule.percent || 0);
        if (percent === 0) continue; // Skip if no actual bonus
        
        // Mark as received
        userEcoAfter.receivedBonuses[i] = Date.now();
        await setEconomyUser(interaction.guild.id, interaction.user.id, userEcoAfter);
        
        console.log(`[BONUS DEBUG] ‚úÖ NEW BONUS UNLOCKED: ${rule.name} (+${percent}%)`);
        
        // Send notification embed
        const bonusName = rule.name || 'Nouveau bonus';
        const isPositive = percent > 0;
        const color = isPositive ? 0xFFD700 : 0xFF6B6B; // Gold or Red
        const emoji = isPositive ? 'üåü' : '‚ö†Ô∏è';
        
        let description = `Vous venez de d√©bloquer un nouveau bonus karma !\n\n`;
        description += `**Effet :** ${percent > 0 ? '+' : ''}${percent}% sur vos gains d'actions\n`;
        description += `**Condition :** ${condition}`;
        
        const embed = new EmbedBuilder()
          .setColor(color)
          .setTitle(`${emoji} ${bonusName}`)
          .setDescription(description)
          .addFields(
            { name: 'üìä Condition remplie', value: condition, inline: false },
            { name: 'üí∞ Bonus actuel', value: `${percent > 0 ? '+' : ''}${percent}%`, inline: true },
            { name: 'üéØ Charme actuel', value: String(userEcoAfter.charm || 0), inline: true },
            { name: 'üî• Perversion actuelle', value: String(userEcoAfter.perversion || 0), inline: true }
          )
          .setThumbnail(currentThumbnailImage)
          .setTimestamp(new Date())
          .setFooter({ text: 'BAG ‚Ä¢ Syst√®me de bonus karma', iconURL: currentFooterIcon });
        
        // Send as channel message (not followUp) to ensure visibility
        try {
          // Try followUp first
          await interaction.followUp({
            embeds: [embed],
            ephemeral: false
          });
          console.log(`[BONUS DEBUG] Notification embed sent via followUp for: ${bonusName}`);
        } catch (err) {
          console.log(`[BONUS DEBUG] FollowUp failed (${err.message}), trying channel message...`);
          // Fallback: send directly to channel
          try {
            await interaction.channel.send({
              content: `${interaction.user}`,
              embeds: [embed]
            });
            console.log(`[BONUS DEBUG] Notification embed sent via channel.send for: ${bonusName}`);
          } catch (err2) {
            console.log(`[BONUS DEBUG] Channel.send also failed: ${err2.message}`);
          }
        }
        
        // Only announce one bonus per action
        break;
      }
    }
  } catch (error) {
    console.error('[BONUS DEBUG] Error in maybeAnnounceNewKarmaBonus:', error.message);
  }
}

// Check and notify about newly unlocked shop discounts
async function maybeAnnounceNewShopDiscount(interaction, eco, userEcoAfter, actionKey, prevCharm, prevPerversion) {
  try {
    const discounts = eco.karmaModifiers?.shop || [];
    if (!discounts.length) return;
    
    // Initialize receivedShopDiscounts if not exists
    if (!userEcoAfter.receivedShopDiscounts) userEcoAfter.receivedShopDiscounts = {};
    
    console.log(`[SHOP DISCOUNT DEBUG] Checking for new discounts: prevCharm=${prevCharm}, newCharm=${userEcoAfter.charm}, prevPerv=${prevPerversion}, newPerv=${userEcoAfter.perversion}`);
    
    for (let i = 0; i < discounts.length; i++) {
      const rule = discounts[i];
      if (!rule || typeof rule !== 'object') continue;
      if (userEcoAfter.receivedShopDiscounts[i]) continue; // Already announced
      
      const condition = String(rule.condition || '');
      if (!condition) continue;
      
      // Check if discount was just unlocked
      const wasOk = evaluateKarmaCondition(condition, Number(prevCharm || 0), Number(prevPerversion || 0), 0);
      const nowOk = evaluateKarmaCondition(condition, userEcoAfter.charm || 0, userEcoAfter.perversion || 0, 0);
      
      console.log(`[SHOP DISCOUNT DEBUG] Rule ${i}: ${rule.name} | wasOk=${wasOk}, nowOk=${nowOk}`);
      
      if (!wasOk && nowOk) {
        // NEW DISCOUNT UNLOCKED!
        const percent = Number(rule.percent || 0);
        if (percent === 0) continue; // Skip if no actual discount
        
        // Mark as received
        userEcoAfter.receivedShopDiscounts[i] = Date.now();
        await setEconomyUser(interaction.guild.id, interaction.user.id, userEcoAfter);
        
        console.log(`[SHOP DISCOUNT DEBUG] ‚úÖ NEW DISCOUNT UNLOCKED: ${rule.name} (${percent}%)`);
        
        // Send notification embed
        const discountName = rule.name || 'Nouvelle r√©duction';
        const isDiscount = percent < 0;
        const color = isDiscount ? 0x00D9FF : 0xFF6B6B; // Cyan for discount, Red for penalty
        const emoji = isDiscount ? 'üõçÔ∏è' : 'üí∏';
        
        let description = `Vous venez de d√©bloquer une nouvelle r√©duction boutique !\n\n`;
        description += `**Effet :** ${percent}% sur les prix de la boutique\n`;
        description += `**Condition :** ${condition}`;
        
        const embed = new EmbedBuilder()
          .setColor(color)
          .setTitle(`${emoji} ${discountName}`)
          .setDescription(description)
          .addFields(
            { name: 'üìä Condition remplie', value: condition, inline: false },
            { name: 'üíé R√©duction', value: `${percent}%`, inline: true },
            { name: 'üéØ Charme actuel', value: String(userEcoAfter.charm || 0), inline: true },
            { name: 'üî• Perversion actuelle', value: String(userEcoAfter.perversion || 0), inline: true }
          )
          .setThumbnail(currentThumbnailImage)
          .setTimestamp(new Date())
          .setFooter({ text: 'BAG ‚Ä¢ R√©ductions boutique karma', iconURL: currentFooterIcon });
        
        // Send as channel message
        try {
          await interaction.followUp({
            embeds: [embed],
            ephemeral: false
          });
          console.log(`[SHOP DISCOUNT DEBUG] Notification embed sent via followUp for: ${discountName}`);
        } catch (err) {
          console.log(`[SHOP DISCOUNT DEBUG] FollowUp failed (${err.message}), trying channel message...`);
          try {
            await interaction.channel.send({
              content: `${interaction.user}`,
              embeds: [embed]
            });
            console.log(`[SHOP DISCOUNT DEBUG] Notification embed sent via channel.send for: ${discountName}`);
          } catch (err2) {
            console.log(`[SHOP DISCOUNT DEBUG] Channel.send also failed: ${err2.message}`);
          }
        }
        
        // Only announce one discount per action
        break;
      }
    }
  } catch (error) {
    console.error('[SHOP DISCOUNT DEBUG] Error in maybeAnnounceNewShopDiscount:', error.message);
  }
}

// Calculate final shop price with cumulative booster and karma modifiers
async function calculateShopPrice(guild, user, basePrice) {
  const eco = await getEconomyConfig(guild.id);
  const userEco = await getEconomyUser(guild.id, user.id);
  
  // totalDeltaPercent: positif = augmente le prix, n√©gatif = baisse le prix
  let totalDeltaPercent = 0;
  
  // Add booster discount
  try {
    const b = eco.booster || {};
    const member = await guild.members.fetch(user.id).catch(() => null);
    const isNitroBooster = Boolean(member?.premiumSince || member?.premiumSinceTimestamp);
    const boosterRoleIds = Array.isArray(b.roles) ? b.roles.map(String) : [];
    const hasBoosterRole = member ? boosterRoleIds.some((rid) => member.roles?.cache?.has(rid)) : false;
    const isBooster = isNitroBooster || hasBoosterRole;
    if (b.enabled && isBooster && Number(b.shopPriceMult) > 0) {
      const boosterMult = Number(b.shopPriceMult);
      const boosterDeltaPercent = -((1 - boosterMult) * 100); // remise ‚Üí delta n√©gatif
      totalDeltaPercent += boosterDeltaPercent;
    }
  } catch (_) {}
  
  // Add karma discount
  const karmaPercent = calculateKarmaShopModifier(eco.karmaModifiers?.shop, userEco.charm || 0, userEco.perversion || 0);
  totalDeltaPercent += karmaPercent; // positif = augmentation, n√©gatif = remise
  
  // Apply cumulative discount
  const finalMultiplier = Math.max(0, 1 + totalDeltaPercent / 100);
  return Math.max(0, Math.floor(basePrice * finalMultiplier));
}
// Build detailed boutique embed showing base prices and karma-modified prices
async function buildBoutiqueEmbed(guild, user, offset = 0, limit = 25) {
  const eco = await getEconomyConfig(guild.id);
  const userEco = await getEconomyUser(guild.id, user.id);
  const userCharm = userEco.charm || 0;
  const userPerversion = userEco.perversion || 0;
  const currency = eco.currency?.name || 'BAG$';
  
  // Check if user is a booster
  let isBooster = false;
  let boosterMult = 1;
  try {
    const b = eco.booster || {};
    const member = await guild.members.fetch(user.id).catch(() => null);
    const isNitroBooster = Boolean(member?.premiumSince || member?.premiumSinceTimestamp);
    const boosterRoleIds = Array.isArray(b.roles) ? b.roles.map(String) : [];
    const hasBoosterRole = member ? boosterRoleIds.some((rid) => member.roles?.cache?.has(rid)) : false;
    isBooster = isNitroBooster || hasBoosterRole;
    if (b.enabled && isBooster && Number(b.shopPriceMult) > 0) {
      boosterMult = Number(b.shopPriceMult);
    }
  } catch (_) {}
  
  // Calculate karma modifier percentage
  const karmaPercent = calculateKarmaShopModifier(eco.karmaModifiers?.shop, userCharm, userPerversion);
  const karmaFactor = Math.max(0, 1 + karmaPercent / 100);
  
  const embed = new EmbedBuilder()
    .setColor(THEME_COLOR_PRIMARY)
    .setTitle('üõçÔ∏è Boutique BAG')
    .setThumbnail(currentThumbnailImage)
    .setFooter({ text: 'Boy and Girls (BAG)', iconURL: currentFooterIcon });
  
  // Calculate total delta for display (positif = augmente, n√©gatif = baisse)
  let totalDeltaPercent = 0;
  if (isBooster && boosterMult !== 1) {
    totalDeltaPercent += -((1 - boosterMult) * 100);
  }
  totalDeltaPercent += karmaPercent;
  
  // User info
  let description = `üí∞ **Votre solde :** ${userEco.amount || 0} ${currency}\n`;
  description += `‚ú® **Charme :** ${userCharm} | üòà **Perversion :** ${userPerversion}\n`;
  
  // Show individual modifiers
  if (isBooster && boosterMult !== 1) {
    const boosterDiscount = (1 - boosterMult) * 100;
    description += `üöÄ **Bonus booster :** ${Math.round(-boosterDiscount)}%\n`;
  }
  if (karmaPercent !== 0) {
    const sign = karmaPercent > 0 ? '+' : '';
    description += `üéØ **Modification karma :** ${sign}${karmaPercent}%\n`;
  }
  
  // Show total cumulative delta
  if (totalDeltaPercent !== 0) {
    const sign = totalDeltaPercent > 0 ? '+' : '';
    const totalText = totalDeltaPercent <= -100 ? '**ARTICLES GRATUITS!** üéâ' : `**Total : ${sign}${Math.round(totalDeltaPercent)}%**`;
    description += `üí∏ **Impact cumul√© :** ${totalText}\n`;
  }
  
  description += '\n**Articles disponibles :**';
  
  embed.setDescription(description);
  
  const fields = [];
  
  // Helper function to calculate final price with cumulative modifiers (positive = augmente, n√©gatif = baisse)
  const calculateFinalPrice = (basePrice) => {
    let price = basePrice;
    
    let totalDeltaPercent = 0;
    
    // Booster delta (multiplier < 1 => remise n√©gative)
    if (isBooster && boosterMult !== 1) {
      const boosterDiscountPercent = (1 - boosterMult) * 100;
      totalDeltaPercent += -boosterDiscountPercent;
    }
    
    // Karma delta (d√©j√† sign√©)
    totalDeltaPercent += karmaPercent;
    
    const finalMultiplier = Math.max(0, 1 + totalDeltaPercent / 100);
    price = Math.max(0, Math.floor(basePrice * finalMultiplier));
    
    return { finalPrice: price, totalDeltaPercent };
  };
  
  // Helper function to format price display with discount info
  const formatPrice = (basePrice) => {
    const { finalPrice, totalDeltaPercent } = calculateFinalPrice(basePrice);
    
    if (finalPrice === basePrice) {
      return `**${finalPrice}** ${currency}`;
    } else {
      const suffix = totalDeltaPercent <= -100 ? ' (GRATUIT!)' : ` (${totalDeltaPercent>0?'+':''}${Math.round(totalDeltaPercent)}%)`;
      return `~~${basePrice}~~ **${finalPrice}** ${currency}${suffix}`;
    }
  };
  
  // Pagination des entr√©es: concat√©ner items + roles + suites comme une liste lin√©aire
  const entries = [];
  if (Array.isArray(eco.shop?.items)) {
    for (const item of eco.shop.items) entries.push({ type: 'item', data: item });
  }
  if (Array.isArray(eco.shop?.roles)) {
    for (const role of eco.shop.roles) entries.push({ type: 'role', data: role });
  }
  if (eco.suites) {
    const prices = eco.suites.prices || { day: 0, week: 0, month: 0 };
    const durations = [
      { key: 'day', name: 'Suite priv√©e (1 jour)', emoji: 'üè†' },
      { key: 'week', name: 'Suite priv√©e (7 jours)', emoji: 'üè°' },
      { key: 'month', name: 'Suite priv√©e (30 jours)', emoji: 'üè∞' }
    ];
    for (const dur of durations) entries.push({ type: 'suite', data: { key: dur.key, name: dur.name, emoji: dur.emoji, price: Number(prices[dur.key] || 0) } });
  }
  const total = entries.length;
  const slice = entries.slice(offset, offset + limit);
  
  // Regrouper par sections pour l'embed (Discord limite 25 fields et la taille globale)
  // On reconstruit des champs pour les √©l√©ments affich√©s uniquement
  const itemsShown = slice.filter(e => e.type === 'item').map(e => e.data);
  const rolesShown = slice.filter(e => e.type === 'role').map(e => e.data);
  const suitesShown = slice.filter(e => e.type === 'suite').map(e => e.data);

  // Objets
  if (itemsShown.length) {
    let itemsText = '';
    for (const item of itemsShown) {
      const basePrice = item.price || 0;
      const emoji = item.emoji || 'üéÅ';
      itemsText += `${emoji} ${item.name || item.id} - ${formatPrice(basePrice)}\n`;
    }
    if (itemsText) fields.push({ name: 'üéÅ Objets', value: itemsText, inline: false });
  }
  
  // R√¥les
  if (rolesShown.length) {
    let rolesText = '';
    for (const role of rolesShown) {
      const roleName = guild.roles.cache.get(role.roleId)?.name || role.name || role.roleId;
      const duration = role.durationDays ? ` (${role.durationDays}j)` : ' (permanent)';
      const basePrice = role.price || 0;
      console.log("[CONFIGBIENVENUE DEBUG] Commande re√ßue");
      rolesText += `‚Ä¢ ${roleName}${duration} - ${formatPrice(basePrice)}\n`;
    }
    if (rolesText) fields.push({ name: 'üé≠ R√¥les', value: rolesText, inline: false });
  }
  
  // Suites priv√©es
  if (suitesShown.length) {
    let suitesText = '';
    for (const s of suitesShown) {
      suitesText += `${s.emoji} ${s.name} - ${formatPrice(s.price)}\n`;
    }
    if (suitesText) fields.push({ name: `${eco.suites.emoji || 'üíû'} Suites Priv√©es`, value: suitesText, inline: false });
  }
  
  if (fields.length === 0) {
    embed.setDescription(description + '\n*Aucun article disponible pour le moment.*');
  } else {
    embed.addFields(...fields);
  }
  
  // Footer pagination
  if (total > limit) {
    const from = Math.min(total, offset + 1);
    const to = Math.min(total, offset + limit);
    embed.setFooter({ text: `Boy and Girls (BAG) ‚Ä¢ ${from}-${to} sur ${total}`, iconURL: currentFooterIcon });
  }
  return embed;
}

async function buildBoutiqueRows(guild) {
  const eco = await getEconomyConfig(guild.id);
  const options = [];
  // Items
  for (const it of (eco.shop?.items || [])) {
    const emoji = it.emoji || 'üéÅ';
    const label = emoji + ' ' + (it.name || it.id) + ' ‚Äî ' + (it.price||0);
    options.push({ label, value: 'item:' + it.id });
  }
  // Roles
  for (const r of (eco.shop?.roles || [])) {
    const roleName = guild.roles.cache.get(r.roleId)?.name || r.name || r.roleId;
    const dur = r.durationDays ? (r.durationDays + 'j') : 'permanent';
    const label = 'R√¥le: ' + roleName + ' ‚Äî ' + (r.price||0) + ' (' + dur + ')';
    options.push({ label, value: 'role:' + r.roleId + ':' + (r.durationDays||0) });
  }
  // Suites (private rooms)
  if (eco.suites) {
    const prices = eco.suites.prices || { day:0, week:0, month:0 };
    const labels = [
      { key:'day', name:'Suite priv√©e (1j)' },
      { key:'week', name:'Suite priv√©e (7j)' },
      { key:'month', name:'Suite priv√©e (30j)' },
    ];
    for (const l of labels) {
      const price = Number(prices[l.key]||0);
      const label = (eco.suites.emoji || 'üíû') + ' ' + l.name + ' ‚Äî ' + price;
      options.push({ label, value: 'suite:' + l.key });
    }
  }
  const select = new StringSelectMenuBuilder().setCustomId('boutique_select').setPlaceholder('Choisir un article‚Ä¶').setMinValues(1).setMaxValues(1);
  if (options.length) select.addOptions(...options);
  else select.addOptions({ label: 'Aucun article disponible', value: 'none' }).setDisabled(true);
  const row = new ActionRowBuilder().addComponents(select);
  return [row];
}

function buildBoutiquePageRow(offset, limit, total) {
  const hasPrev = offset > 0;
  const hasNext = offset + limit < total;
  const prevOffset = Math.max(0, offset - limit);
  const nextOffset = offset + limit;
  const prevBtn = new ButtonBuilder().setCustomId(`boutique_page:${prevOffset}:${limit}`).setLabel('‚ü® Pr√©c√©dent').setStyle(ButtonStyle.Secondary).setDisabled(!hasPrev);
  const nextBtn = new ButtonBuilder().setCustomId(`boutique_page:${nextOffset}:${limit}`).setLabel('Suivant ‚ü©').setStyle(ButtonStyle.Primary).setDisabled(!hasNext);
  return new ActionRowBuilder().addComponents(prevBtn, nextBtn);
}

async function getBoutiqueEntriesCount(guild) {
  const eco = await getEconomyConfig(guild.id);
  let count = 0;
  count += Array.isArray(eco.shop?.items) ? eco.shop.items.length : 0;
  count += Array.isArray(eco.shop?.roles) ? eco.shop.roles.length : 0;
  if (eco.suites) count += 3; // day/week/month
  return { entriesCount: count };
}

client.on(Events.GuildMemberAdd, async (member) => {
  try {
    const ak = await getAutoKickConfig(member.guild.id);
    if (!ak?.enabled) return;
    await addPendingJoiner(member.guild.id, member.id, Date.now());
  } catch (_) {}
});

// √âv√©nement : Le bot rejoint un nouveau serveur
client.on(Events.GuildCreate, async (guild) => {
  try {
    console.log(`[Bot] Rejoint un nouveau serveur: ${guild.name} (${guild.id})`);
    guildManager.addGuild(guild);
    
    // Initialiser le stockage pour ce serveur
    await ensureStorageExists();
    console.log(`[Bot] Stockage initialis√© pour ${guild.name}`);
  } catch (error) {
    console.error(`[Bot] Erreur lors de l'ajout du serveur ${guild.id}:`, error);
  }
});

// √âv√©nement : Le bot quitte un serveur
client.on(Events.GuildDelete, async (guild) => {
  try {
    console.log(`[Bot] A quitt√© le serveur: ${guild.name} (${guild.id})`);
    guildManager.removeGuild(guild.id);
  } catch (error) {
    console.error(`[Bot] Erreur lors du retrait du serveur ${guild.id}:`, error);
  }
});

// Note: no automatic booster role assignment on join
